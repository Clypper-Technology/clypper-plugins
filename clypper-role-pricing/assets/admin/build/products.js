(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{addRule:()=>p,deleteRule:()=>m,setError:()=>y,setLoading:()=>g,setRules:()=>u,updateRule:()=>h});var r={};e.r(r),e.d(r,{getError:()=>b,getRuleById:()=>_,getRules:()=>x,getRulesByRole:()=>v,isLoading:()=>f});var a={};e.r(a),e.d(a,{getRules:()=>j});const s=window.wp.element,l=window.wp.components,n=window.wp.data,o=window.wp.notices,c=window.wp.apiFetch;var i=e.n(c);const d={rules:[],isLoading:!1,error:null},u=e=>({type:"SET_RULES",rules:e}),p=e=>({type:"ADD_RULE",rule:e}),h=e=>({type:"UPDATE_RULE",rule:e}),m=e=>({type:"DELETE_RULE",id:e}),g=e=>({type:"SET_LOADING",isLoading:e}),y=e=>({type:"SET_ERROR",error:e}),x=e=>e.rules,_=(e,t)=>e.rules.find(e=>e.id===t),v=(0,n.createSelector)([e=>e.rules,(e,t)=>t],(e,t)=>t?e.filter(e=>e.role_name===t):e),f=e=>e.isLoading,b=e=>e.error,j=()=>async({dispatch:e})=>{e(g(!0));try{const t=await i()({path:"/rrb2b/v1/rules"});e(u(t))}catch(t){const r=t instanceof Error?t.message:"Failed to load rules";e(y(r)),console.error("Error fetching rules:",t)}finally{e(g(!1))}},w="rrb2b/rules",S=(0,n.createReduxStore)(w,{reducer:(e=d,t)=>{switch(t.type){case"SET_RULES":return{...e,rules:t.rules,error:null};case"ADD_RULE":return{...e,rules:[...e.rules,t.rule]};case"UPDATE_RULE":return{...e,rules:e.rules.map(e=>e.id===t.rule.id?t.rule:e)};case"DELETE_RULE":return{...e,rules:e.rules.filter(e=>e.id!==t.id)};case"SET_LOADING":return{...e,isLoading:t.isLoading};case"SET_ERROR":return{...e,error:t.error};default:return e}},actions:t,selectors:r,resolvers:a});(0,n.register)(S);const C=()=>{const[e,t]=(0,s.useState)([]),[r,a]=(0,s.useState)(!1),l=async()=>{a(!0);try{const e=await i()({path:"/wc/v3/products/categories?per_page=999"});t(e)}catch(e){console.error("Error fetching categories:",e),t([])}finally{a(!1)}};return(0,s.useEffect)(()=>{l()},[]),{categories:e,isLoading:r,fetchCategories:l}},E=[{label:"Select Type",value:""},{label:"Percentage Discount",value:"percentage"},{label:"Fixed Amount Discount",value:"fixed"},{label:"Fixed Price",value:"fixed_price"}],k=window.ReactJSXRuntime,R=({ruleId:e,product:t,formData:r,onChange:a,onSelect:s,isSelected:n,hasChanges:o})=>{const c=["crp-product-row",n&&"selected-row",o&&"has-changes"].filter(Boolean).join(" ");return(0,k.jsxs)("tr",{className:c,children:[(0,k.jsx)("td",{className:"crp-table__checkbox-cell",children:(0,k.jsx)(l.CheckboxControl,{checked:n,onChange:t=>s(e,t),__nextHasNoMarginBottom:!0})}),(0,k.jsx)("td",{className:"crp-product-row__thumbnail-cell",children:t?.thumbnail&&(0,k.jsx)("img",{src:t.thumbnail,alt:t.name,className:"crp-product-row__thumbnail"})}),(0,k.jsxs)("td",{className:"crp-product-row__name-cell",children:[(0,k.jsx)("strong",{children:t?.name||"Unknown Product"}),t?.sku&&(0,k.jsxs)("div",{className:"crp-product-row__sku",children:["SKU: ",t.sku]}),o&&(0,k.jsx)("div",{className:"crp-product-row__unsaved-indicator",children:"● Unsaved changes"})]}),(0,k.jsx)("td",{children:(0,k.jsx)(l.SelectControl,{value:r.rule_type,options:E,onChange:t=>a(e,"rule_type",t),__nextHasNoMarginBottom:!0})}),(0,k.jsx)("td",{children:(0,k.jsx)(l.TextControl,{value:r.rule_value,onChange:t=>a(e,"rule_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})}),(0,k.jsx)("td",{children:(0,k.jsx)(l.TextControl,{value:String(r.min_quantity),onChange:t=>a(e,"min_quantity",parseInt(t)||0),placeholder:"0",type:"number",__nextHasNoMarginBottom:!0})}),(0,k.jsx)("td",{children:(0,k.jsx)(l.SelectControl,{value:r.qty_rule_type,options:E,onChange:t=>a(e,"qty_rule_type",t),__nextHasNoMarginBottom:!0})}),(0,k.jsx)("td",{children:(0,k.jsx)(l.TextControl,{value:r.qty_rule_value,onChange:t=>a(e,"qty_rule_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})})]})},N=({isOpen:e,title:t,message:r,onConfirm:a,onCancel:s,isDangerous:n=!1})=>e?(0,k.jsxs)(l.Modal,{title:t,onRequestClose:s,className:"crp-confirm-dialog",children:[(0,k.jsx)("p",{children:r}),(0,k.jsxs)("div",{className:"crp-modal-actions",style:{display:"flex",justifyContent:"flex-end",gap:"10px",marginTop:"20px"},children:[(0,k.jsx)(l.Button,{onClick:s,children:"Cancel"}),(0,k.jsx)(l.Button,{variant:"primary",onClick:a,isDestructive:n,children:"Confirm"})]})]}):null,T=({rules:e,products:t,isLoading:r,roleFilter:a,onUpdate:n,onBulkUpdate:o,onBulkDelete:c,onAddProduct:d,onRefetch:u})=>{const[p,h]=(0,s.useState)([]),[m,g]=(0,s.useState)(""),[y,x]=(0,s.useState)(""),[_,v]=(0,s.useState)(""),[f,b]=(0,s.useState)(!1),[j,w]=(0,s.useState)(new Map),[S,C]=(0,s.useState)(new Set),[T,L]=(0,s.useState)(!1);(0,s.useEffect)(()=>{const t=new Map;e.forEach(e=>{if(j.has(e.id))t.set(e.id,j.get(e.id));else{const r=e.products?.[0];t.set(e.id,{rule_type:r?.rule?.type||"",rule_value:r?.rule?.value||"",min_quantity:r?.min_qty||0,qty_rule_type:r?.rule?.quantity_type||"",qty_rule_value:r?.rule?.quantity||""})}}),w(t)},[e]);const P=(0,s.useMemo)(()=>m?e.filter(e=>(e.products||[]).some(e=>{const r=m.toLowerCase();if(e.name&&e.name.toLowerCase().includes(r))return!0;const a=t.get(e.id);return!(!a?.sku||!a.sku.toLowerCase().includes(r))})):e,[e,m,t]),B=(e,t)=>{h(t?[...p,e]:p.filter(t=>t!==e))},D=(e,t,r)=>{const a=j.get(e);if(!a)return;const s={...a,[t]:r},l=new Map(j);l.set(e,s),w(l);const n=new Set(S);n.add(e),C(n)};return r?(0,k.jsx)("div",{style:{display:"flex",justifyContent:"center",padding:"40px"},children:(0,k.jsx)(l.Spinner,{})}):(0,k.jsxs)(k.Fragment,{children:[(0,k.jsx)("div",{style:{marginBottom:"16px"},children:(0,k.jsx)("div",{style:{maxWidth:"300px"},children:(0,k.jsx)(l.TextControl,{label:"Filter Existing Rules",value:m,onChange:g,placeholder:"Filter by product name or SKU...",help:"Search within the table below"})})}),p.length>0&&(0,k.jsx)("div",{style:{marginBottom:"16px"},children:(0,k.jsxs)("div",{style:{display:"flex",gap:"10px",alignItems:"flex-end",flexWrap:"wrap"},children:[(0,k.jsx)("div",{style:{minWidth:"150px"},children:(0,k.jsx)(l.SelectControl,{label:"Bulk Rule Type",value:y,options:E,onChange:x})}),(0,k.jsx)(l.Button,{variant:"secondary",onClick:async()=>{0!==p.length&&y&&(await o(p,{rule_type:y}),x(""))},disabled:!y,children:"Apply Type"}),(0,k.jsx)("div",{style:{minWidth:"100px"},children:(0,k.jsx)(l.TextControl,{label:"Bulk Value",value:_,onChange:v,placeholder:"e.g., 10"})}),(0,k.jsx)(l.Button,{variant:"secondary",onClick:async()=>{0!==p.length&&_&&(await o(p,{rule_value:_}),v(""))},disabled:!_,children:"Apply Value"}),(0,k.jsxs)(l.Button,{variant:"secondary",isDestructive:!0,onClick:()=>b(!0),children:["Delete (",p.length,")"]})]})}),S.size>0&&(0,k.jsxs)("div",{className:"crp-save-banner",children:[(0,k.jsxs)("span",{className:"crp-save-banner__message",children:[(0,k.jsx)("strong",{children:S.size})," unsaved change",1!==S.size?"s":""]}),(0,k.jsxs)("div",{className:"crp-save-banner__actions",children:[(0,k.jsx)(l.Button,{variant:"secondary",onClick:()=>window.location.reload(),disabled:T,children:"Discard Changes"}),(0,k.jsx)(l.Button,{variant:"primary",onClick:async()=>{if(0!==S.size){L(!0);try{for(const t of Array.from(S)){const r=e.find(e=>e.id===t);if(!r)continue;const a=r.products?.map(e=>{const r=j.get(t);return{product_id:e.id,product_name:e.name,type:r?.rule_type||e.rule?.type||"percentage",value:r?.rule_value||e.rule?.value||"0",min_qty:r?.min_quantity||e.min_qty||1,quantity:r?.qty_rule_value||e.rule?.quantity||"",quantity_type:r?.qty_rule_type||e.rule?.quantity_type||""}})||[];await i()({path:`/rrb2b/v1/rules/${t}/products`,method:"PUT",data:{rows:a}})}C(new Set),u&&u()}catch(e){console.error("Failed to save changes:",e)}finally{L(!1)}}},isBusy:T,disabled:T,children:"Save All Changes"})]})]}),0===P.length?(0,k.jsx)("div",{className:"crp-empty-state",children:(0,k.jsx)("p",{className:"crp-empty-state__text",children:m?"No products match your search.":"No product rules found. Add products using the search above."})}):(0,k.jsx)("div",{className:"crp-table-container",children:(0,k.jsxs)("table",{className:"wp-list-table widefat fixed striped crp-table",children:[(0,k.jsx)("thead",{children:(0,k.jsxs)("tr",{children:[(0,k.jsx)("th",{style:{width:"40px"},children:(0,k.jsx)("input",{type:"checkbox",checked:p.length===P.length&&P.length>0,onChange:()=>{p.length===P.length?h([]):h(P.map(e=>e.id))}})}),(0,k.jsx)("th",{style:{width:"60px"},children:"Image"}),(0,k.jsx)("th",{children:"Product"}),(0,k.jsx)("th",{children:"Rule Type"}),(0,k.jsx)("th",{children:"Value"}),(0,k.jsx)("th",{children:"Minimum Quantity"}),(0,k.jsx)("th",{children:"Quantity Rule Type"}),(0,k.jsx)("th",{children:"Quantity Value"})]})}),(0,k.jsx)("tbody",{children:P.map(e=>{const r=e.products?.[0],a=r?{id:r.id,name:r.name,sku:"",thumbnail:t.get(r.id)?.thumbnail||""}:null,s=j.get(e.id)||{rule_type:"",rule_value:"",min_quantity:0,qty_rule_type:"",qty_rule_value:""};return(0,k.jsx)(R,{ruleId:e.id,product:a,formData:s,onChange:D,onSelect:B,isSelected:p.includes(e.id),hasChanges:S.has(e.id)},e.id)})})]})}),(0,k.jsx)(N,{isOpen:f,title:"Delete Selected Rules",message:`Are you sure you want to delete ${p.length} selected rule(s)? This action cannot be undone.`,onConfirm:async()=>{0!==p.length&&(await c(p),h([]),b(!1))},onCancel:()=>b(!1),isDangerous:!0})]})},L=window.wp.compose,P=({onSelect:e,ruleId:t,placeholder:r="Search products..."})=>{const[a,n]=(0,s.useState)(""),[o,c]=(0,s.useState)([]),[d,u]=(0,s.useState)(!1),[p,h]=(0,s.useState)(!1),{searchProducts:m}=(()=>{const[e,t]=(0,s.useState)(!1);return{searchProducts:async(e,r)=>{if(!e||e.length<2)return[];t(!0);try{return r?await i()({path:`/rrb2b/v1/rules/${r}/products/search`,method:"POST",data:{search:e}}):(await i()({path:`/wc/v3/products?search=${encodeURIComponent(e)}&per_page=20`})).map(e=>({id:e.id,name:e.name,sku:e.sku,price:e.price,thumbnail:e.images?.[0]?.src||""}))}catch(e){return console.error("Error searching products:",e),[]}finally{t(!1)}},getProductsByCategory:async e=>{t(!0);try{return(await i()({path:`/wc/v3/products?category=${e}&per_page=100`})).map(e=>({id:e.id,name:e.name,sku:e.sku,price:e.price,thumbnail:e.images?.[0]?.src||""}))}catch(e){return console.error("Error fetching products by category:",e),[]}finally{t(!1)}},isSearching:e}})(),g=(0,s.useMemo)(()=>(0,L.debounce)(async e=>{if(e.length<2)return c([]),void h(!1);h(!0);const r=await m(e,t);c(r),u(!0),h(!1)},300),[t,m]);return(0,s.useEffect)(()=>{a.length>=2&&h(!0),g(a)},[a,g]),(0,k.jsxs)("div",{className:"crp-product-search",children:[(0,k.jsx)(l.TextControl,{label:"Search Products",value:a,onChange:n,placeholder:r,autoComplete:"off"}),p&&(0,k.jsx)("div",{className:"crp-product-search__spinner",children:(0,k.jsx)(l.Spinner,{})}),d&&o.length>0&&(0,k.jsx)("div",{className:"crp-product-search__results",children:o.map(t=>(0,k.jsxs)("button",{onClick:()=>(t=>{e(t),n(""),c([]),u(!1)})(t),className:"crp-product-search__result-item",children:[t.thumbnail&&(0,k.jsx)("img",{src:t.thumbnail,alt:t.name,className:"crp-product-search__result-thumbnail"}),(0,k.jsxs)("div",{className:"crp-product-search__result-details",children:[(0,k.jsx)("div",{className:"crp-product-search__result-name",children:t.name}),t.sku&&(0,k.jsxs)("div",{className:"crp-product-search__result-sku",children:["SKU: ",t.sku]})]}),t.price&&(0,k.jsxs)("div",{className:"crp-product-search__result-price",children:["$",t.price]})]},t.id))}),a.length>=2&&0===o.length&&!p&&(0,k.jsx)("div",{className:"crp-product-search__no-results",children:"No products found"})]})},B=({value:e,onChange:t,label:r="Categories"})=>{const{categories:a,isLoading:n}=C(),[o,c]=(0,s.useState)(!1),[i,d]=(0,s.useState)(""),u=(0,s.useMemo)(()=>a.filter(t=>e.includes(t.id)),[a,e]),p=(0,s.useMemo)(()=>i?a.filter(e=>e.name.toLowerCase().includes(i.toLowerCase())):a,[a,i]);return(0,k.jsxs)("div",{className:"crp-category-multiselect",children:[(0,k.jsx)("label",{className:"components-base-control__label",children:r}),(0,k.jsx)("div",{className:"selected-categories",style:{marginBottom:"8px",display:"flex",flexWrap:"wrap",gap:"4px"},children:0===u.length?(0,k.jsx)("span",{style:{color:"#757575",fontSize:"13px"},children:"No categories selected"}):u.map(r=>(0,k.jsxs)("span",{className:"category-tag",style:{display:"inline-flex",alignItems:"center",padding:"4px 8px",background:"#f0f0f0",borderRadius:"4px",fontSize:"12px",gap:"6px"},children:[r.name,(0,k.jsx)("button",{onClick:()=>(r.id,void t(e)),style:{border:"none",background:"transparent",cursor:"pointer",padding:0,fontSize:"14px",lineHeight:1},"aria-label":`Remove ${r.name}`,children:"×"})]},r.id))}),(0,k.jsx)(l.Button,{variant:"secondary",onClick:()=>c(!o),children:o?"Close":"Select Categories"}),o&&(0,k.jsx)(l.Popover,{position:"bottom left",onClose:()=>c(!1),className:"crp-category-popover",children:(0,k.jsxs)("div",{style:{width:"300px",padding:"12px"},children:[(0,k.jsx)(l.TextControl,{label:"Search",value:i,onChange:d,placeholder:"Search categories..."}),n?(0,k.jsx)("p",{children:"Loading categories..."}):(0,k.jsx)("div",{style:{maxHeight:"300px",overflowY:"auto",marginTop:"8px"},children:0===p.length?(0,k.jsx)("p",{style:{color:"#757575",fontSize:"13px"},children:"No categories found"}):p.map(t=>(0,k.jsx)(l.CheckboxControl,{label:t.name,checked:e.includes(t.id),onChange:()=>handleToggle(t.id)},t.id))})]})})]})},D=({isOpen:e,onClose:t,onAddProduct:r,onAddFromCategory:a,categories:n})=>{const[o,c]=(0,s.useState)([]),[d,u]=(0,s.useState)(!1),[p,h]=(0,s.useState)(!1),[m,g]=(0,s.useState)([]),[y,x]=(0,s.useState)(!1);(0,s.useEffect)(()=>{e&&0===m.length&&_()},[e]);const _=async()=>{x(!0);try{const e=(await i()({path:"/wc/v3/products?per_page=10&orderby=popularity&order=desc"})).map(e=>({id:e.id,name:e.name,sku:e.sku,price:e.price,thumbnail:e.images?.[0]?.src||""}));g(e)}catch(e){console.error("Failed to load suggested products:",e)}finally{x(!1)}},v=async()=>{if(0!==o.length){h(!0);try{await a(o,d),c([]),u(!1),t()}catch(e){console.error("Failed to add products from category:",e)}finally{h(!1)}}},f=async e=>{h(!0);try{await r(e),t()}catch(e){console.error("Failed to add product:",e)}finally{h(!1)}};return e?(0,k.jsx)(l.Modal,{title:"Add Product Rules",onRequestClose:t,className:"crp-add-product-modal",children:(0,k.jsx)(l.TabPanel,{className:"crp-add-product-tabs",tabs:[{name:"search",title:"Add Products"},{name:"category",title:"Add from Category"}],children:e=>"search"===e.name?(0,k.jsxs)("div",{className:"crp-add-product-tabs",children:[(0,k.jsx)("p",{className:"crp-modal__description",children:"Search and select products to add pricing rules."}),(0,k.jsx)(P,{onSelect:f,placeholder:"Search for products..."}),y?(0,k.jsxs)("div",{style:{padding:"20px",textAlign:"center"},children:[(0,k.jsx)(l.Spinner,{}),(0,k.jsx)("p",{children:"Loading suggested products..."})]}):m.length>0&&(0,k.jsxs)("div",{style:{marginTop:"20px"},children:[(0,k.jsx)("h4",{children:"Suggested Products"}),(0,k.jsx)("div",{style:{display:"grid",gap:"8px"},children:m.map(e=>(0,k.jsxs)("button",{onClick:()=>f(e),className:"crp-product-search__result-item",style:{border:"1px solid #ddd",borderRadius:"4px"},children:[e.thumbnail&&(0,k.jsx)("img",{src:e.thumbnail,alt:e.name,className:"crp-product-search__result-thumbnail"}),(0,k.jsxs)("div",{className:"crp-product-search__result-details",children:[(0,k.jsx)("div",{className:"crp-product-search__result-name",children:e.name}),e.sku&&(0,k.jsxs)("div",{className:"crp-product-search__result-sku",children:["SKU: ",e.sku]})]}),e.price&&(0,k.jsxs)("div",{className:"crp-product-search__result-price",children:["$",e.price]})]},e.id))})]})]}):(0,k.jsxs)("div",{className:"crp-add-product-tabs",children:[(0,k.jsx)("p",{className:"crp-modal__description",children:"Select categories to add all products from those categories."}),n.length>0&&(0,k.jsxs)("div",{style:{marginBottom:"15px"},children:[(0,k.jsx)("h4",{children:"Suggested Categories"}),(0,k.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"},children:n.slice(0,6).map(e=>(0,k.jsx)(l.Button,{variant:"secondary",size:"small",onClick:()=>{o.includes(e.id)||c([...o,e.id])},disabled:o.includes(e.id),children:e.name},e.id))})]}),(0,k.jsx)(B,{value:o,onChange:c}),(0,k.jsx)("div",{className:"crp-modal__checkbox-label",children:(0,k.jsxs)("label",{children:[(0,k.jsx)("input",{type:"checkbox",checked:d,onChange:e=>u(e.target.checked),className:"crp-modal__checkbox-input"}),"Include product variations"]})}),(0,k.jsxs)("div",{className:"crp-modal__actions",children:[(0,k.jsx)(l.Button,{variant:"primary",onClick:v,isBusy:p,disabled:0===o.length||p,children:"Add Products from Categories"}),(0,k.jsx)(l.Button,{variant:"tertiary",onClick:t,disabled:p,children:"Cancel"})]})]})})}):null},F=({value:e,onChange:t,roles:r,label:a="Select Role",disabled:s=!1})=>{const n=[{label:"Select Role",value:""},...r.map(e=>({label:e.name,value:e.slug}))];return(0,k.jsx)(l.SelectControl,{label:a,value:e,options:n,onChange:t,disabled:s})},U=({roleFilter:e})=>{const[t,r]=(0,s.useState)(""),[a,c]=(0,s.useState)(!1),d=e||t,{roles:u,isLoading:p}=(()=>{const[e,t]=(0,s.useState)([]),[r,a]=(0,s.useState)(!1),{createSuccessNotice:l,createErrorNotice:c}=(0,n.useDispatch)(o.store),d=async()=>{a(!0);try{const e=await i()({path:"/rrb2b/v1/roles",method:"GET"});t(e)}catch(e){const t=e instanceof Error?e.message:"Unknown error";c(`Failed to load roles: ${t}`),console.error("Error fetching roles:",e)}finally{a(!1)}};return(0,s.useEffect)(()=>{d()},[]),{roles:e,isLoading:r,createRole:async r=>{try{const a={role_name:r.name,role_slug:r.slug,role_cap:r.baseCap||"customer"},s=(await i()({path:"/rrb2b/v1/roles",method:"POST",data:a})).role;return t([...e,s]),l("Role created successfully!",{type:"snackbar"}),s}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw c(`Failed to create role: ${t}`),e}},deleteRole:async r=>{const a=[...e];t(e.filter(e=>e.slug!==r));try{await i()({path:`/rrb2b/v1/roles/${r}`,method:"DELETE"}),l("Role deleted successfully!",{type:"snackbar"})}catch(e){t(a);const r=e instanceof Error?e.message:"Unknown error";throw c(`Failed to delete role: ${r}`),e}},refetch:d}})(),{categories:h,isLoading:m}=C(),{rules:g,isLoading:y,createRule:x,updateRule:_,bulkUpdate:v,bulkDelete:f,refetch:b}=(e=>{const{rules:t,isLoading:r,error:a}=(0,n.useSelect)(t=>{const r=t(w).getRules();return{rules:e?t(w).getRulesByRole(e):r,isLoading:t(w).isLoading(),error:t(w).getError()}},[e]),{addRule:s,updateRule:l,deleteRule:c,invalidateResolution:d}=(0,n.useDispatch)(w),{createSuccessNotice:u,createErrorNotice:p}=(0,n.useDispatch)(o.store),h=async(e,r)=>{const a=t.find(t=>t.id===e);a&&l({...a,...r});try{const t=await i()({path:`/rrb2b/v1/rules/${e}`,method:"PUT",data:r});return l(t),u("Rule updated successfully!",{type:"snackbar"}),t}catch(e){a&&l(a);const t=e instanceof Error?e.message:"Failed to update rule";throw p(`Failed to update rule: ${t}`),e}},m=async e=>{c(e);try{await i()({path:`/rrb2b/v1/rules/${e}`,method:"DELETE"}),u("Rule deleted successfully!",{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to delete rule";throw p(`Failed to delete rule: ${t}`),e}};return{rules:t,isLoading:r,error:a,createRule:async e=>{try{const t={role_name:e.role},r=await i()({path:"/rrb2b/v1/rules",method:"POST",data:t});(void 0!==e.active||e.rule_type||e.rule_value)&&await i()({path:`/rrb2b/v1/rules/${r.id}`,method:"PUT",data:{rule_active:e.active,global_rule:e.rule_type&&e.rule_value?{type:e.rule_type,value:e.rule_value}:void 0}});const a=await i()({path:`/rrb2b/v1/rules/${r.id}`,method:"GET"});return s(a),u("Rule created successfully!",{type:"snackbar"}),a}catch(e){const t=e instanceof Error?e.message:"Failed to create rule";throw p(`Failed to create rule: ${t}`),e}},updateRule:h,deleteRule:m,toggleActive:async e=>{const r=t.find(t=>t.id===e);r&&await h(e,{rule_active:!r.rule_active})},copyRule:async(e,t)=>{try{(await i()({path:`/rrb2b/v1/rules/${e}/copy`,method:"POST",data:{destination_roles:t}})).forEach(e=>s(e)),u(`Rule copied to ${t.length} role(s) successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to copy rule";throw p(`Failed to copy rule: ${t}`),e}},bulkUpdate:async(e,t)=>{try{const r=e.map(e=>h(e,t));await Promise.all(r),u(`${e.length} rule(s) updated successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to bulk update";throw p(`Bulk update failed: ${t}`),e}},bulkDelete:async e=>{try{const t=e.map(e=>m(e));await Promise.all(t),u(`${e.length} rule(s) deleted successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to bulk delete";throw p(`Bulk delete failed: ${t}`),e}},refetch:()=>{d("getRules")}}})(d),[j,S]=(0,s.useState)(new Map),E=g.filter(e=>e.products&&e.products.length>0);(0,s.useEffect)(()=>{E.length>0&&(async()=>{const e=new Set;E.forEach(t=>{t.products?.forEach(t=>e.add(t.id))});const t=new Map(j),r=Array.from(e).filter(e=>!t.has(e));if(r.length>0)try{for(let e=0;e<r.length;e+=20){const a=r.slice(e,e+20);(await i()({path:`/wc/v3/products?include=${a.join(",")}`})).forEach(e=>{t.set(e.id,{id:e.id,name:e.name,sku:e.sku,price:e.price,thumbnail:e.images?.[0]?.src||""})})}S(t)}catch(e){console.error("Failed to fetch products:",e)}})()},[E.length]);const R=async e=>{if(!d)throw new Error("Please select a role first");const t=g.find(e=>e.role_name===d);if(t){const r=[...(t.products||[]).map(e=>({product_id:e.id,product_name:e.name||"",type:e.rule?.type||"percentage",value:e.rule?.value||"0",min_qty:e.min_qty||1})),{product_id:e.id,product_name:e.name,type:"percentage",value:"0",min_qty:1}];await i()({path:`/rrb2b/v1/rules/${t.id}/products`,method:"PUT",data:{rows:r}}),b()}else await x({role:d,rule_type:"percentage",rule_value:"0",active:!0,products:[e.id],productDetails:[{id:e.id,name:e.name}]});S(t=>new Map(t).set(e.id,e))};return(0,k.jsxs)("div",{className:"crp-products-tab",children:[!e&&(0,k.jsxs)(k.Fragment,{children:[(0,k.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,k.jsx)("h2",{children:"Product Pricing Rules"}),(0,k.jsx)("p",{children:"Configure role-based pricing rules for specific products."})]}),(0,k.jsx)("div",{style:{marginBottom:"20px"},children:(0,k.jsx)(F,{value:d,onChange:r,roles:u,label:"Filter by Role",disabled:p})})]}),(0,k.jsx)("div",{style:{marginBottom:"20px"},children:(0,k.jsx)(l.Button,{variant:"secondary",onClick:()=>c(!0),disabled:!d&&!e,children:"+ Add Product Rules"})}),(0,k.jsx)(D,{isOpen:a,onClose:()=>c(!1),onAddProduct:R,onAddFromCategory:async(e,t)=>{if(!d)throw new Error("Please select a role first");const r=g.find(e=>e.role_name===d);if(!r)throw new Error("Please create a rule for this role first");await i()({path:`/rrb2b/v1/rules/${r.id}/products/from-category`,method:"POST",data:{category:e[0],variations:t}}),b()},categories:h}),(0,k.jsx)(T,{rules:E,products:j,isLoading:y,roleFilter:d,onUpdate:_,onBulkUpdate:v,onBulkDelete:f,onAddProduct:R,onRefetch:b})]})};class q extends s.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("React Error:",e,t)}render(){return this.state.hasError?(0,k.jsxs)("div",{className:"notice notice-error",style:{padding:"20px",margin:"20px 0"},children:[(0,k.jsx)("h3",{children:"Something went wrong"}),(0,k.jsx)("p",{children:"The admin interface encountered an error. Please refresh the page to try again."}),this.state.error&&(0,k.jsxs)("details",{style:{marginTop:"10px"},children:[(0,k.jsx)("summary",{children:"Error details"}),(0,k.jsx)("pre",{style:{marginTop:"10px",padding:"10px",background:"#f5f5f5",overflow:"auto"},children:this.state.error.toString()})]})]}):this.props.children}}const $=q,A=()=>{const e=document.getElementById("crp-products-root");e&&(0,s.createRoot)(e).render((0,s.createElement)($,null,(0,s.createElement)(U)))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",A):A()})();
(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{addRule:()=>p,deleteRule:()=>g,setError:()=>x,setLoading:()=>y,setRules:()=>u,updateRule:()=>h});var r={};e.r(r),e.d(r,{getError:()=>j,getRuleById:()=>v,getRules:()=>m,getRulesByRole:()=>f,isLoading:()=>_});var a={};e.r(a),e.d(a,{getRules:()=>b});const l=window.wp.element,s=window.wp.components,n=window.wp.data,o=window.wp.notices,i=window.wp.apiFetch;var c=e.n(i);const d={rules:[],isLoading:!1,error:null},u=e=>({type:"SET_RULES",rules:e}),p=e=>({type:"ADD_RULE",rule:e}),h=e=>({type:"UPDATE_RULE",rule:e}),g=e=>({type:"DELETE_RULE",id:e}),y=e=>({type:"SET_LOADING",isLoading:e}),x=e=>({type:"SET_ERROR",error:e}),m=e=>e.rules,v=(e,t)=>e.rules.find(e=>e.id===t),f=(0,n.createSelector)([e=>e.rules,(e,t)=>t],(e,t)=>t?e.filter(e=>e.role_name===t):e),_=e=>e.isLoading,j=e=>e.error,b=()=>async({dispatch:e})=>{e(y(!0));try{const t=await c()({path:"/rrb2b/v1/rules"});e(u(t))}catch(t){const r=t instanceof Error?t.message:"Failed to load rules";e(x(r)),console.error("Error fetching rules:",t)}finally{e(y(!1))}},C="rrb2b/rules",w=(0,n.createReduxStore)(C,{reducer:(e=d,t)=>{switch(t.type){case"SET_RULES":return{...e,rules:t.rules,error:null};case"ADD_RULE":return{...e,rules:[...e.rules,t.rule]};case"UPDATE_RULE":return{...e,rules:e.rules.map(e=>e.id===t.rule.id?t.rule:e)};case"DELETE_RULE":return{...e,rules:e.rules.filter(e=>e.id!==t.id)};case"SET_LOADING":return{...e,isLoading:t.isLoading};case"SET_ERROR":return{...e,error:t.error};default:return e}},actions:t,selectors:r,resolvers:a});(0,n.register)(w);const S=()=>{const[e,t]=(0,l.useState)([]),[r,a]=(0,l.useState)(!1),s=async()=>{a(!0);try{const e=await c()({path:"/wc/v3/products/categories?per_page=999"});t(e)}catch(e){console.error("Error fetching categories:",e),t([])}finally{a(!1)}};return(0,l.useEffect)(()=>{s()},[]),{categories:e,isLoading:r,fetchCategories:s}},R=[{label:"Select Type",value:""},{label:"Percentage Discount",value:"percentage"},{label:"Fixed Amount Discount",value:"fixed"},{label:"Fixed Price",value:"fixed_price"}],E=window.ReactJSXRuntime,k=({ruleId:e,categoryName:t,formData:r,onChange:a,onSelect:l,isSelected:n,hasChanges:o})=>(0,E.jsxs)("tr",{className:`${n?"selected-row":""} ${o?"has-changes":""}`,children:[(0,E.jsx)("td",{style:{width:"40px",textAlign:"center"},children:(0,E.jsx)(s.CheckboxControl,{checked:n,onChange:t=>l(e,t),__nextHasNoMarginBottom:!0})}),(0,E.jsxs)("td",{style:{minWidth:"150px"},children:[(0,E.jsx)("strong",{children:t}),o&&(0,E.jsx)("div",{style:{fontSize:"11px",color:"#d63638",marginTop:"4px"},children:"● Unsaved changes"})]}),(0,E.jsx)("td",{style:{minWidth:"150px"},children:(0,E.jsx)(s.SelectControl,{value:r.rule_type,options:R,onChange:t=>a(e,"rule_type",t),__nextHasNoMarginBottom:!0})}),(0,E.jsx)("td",{style:{minWidth:"100px"},children:(0,E.jsx)(s.TextControl,{value:r.rule_value,onChange:t=>a(e,"rule_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})}),(0,E.jsx)("td",{style:{minWidth:"100px"},children:(0,E.jsx)(s.TextControl,{value:r.category_value,onChange:t=>a(e,"category_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})}),(0,E.jsx)("td",{style:{minWidth:"100px"},children:(0,E.jsx)(s.TextControl,{value:String(r.min_quantity),onChange:t=>a(e,"min_quantity",parseInt(t)||0),placeholder:"0",type:"number",__nextHasNoMarginBottom:!0})}),(0,E.jsx)("td",{style:{minWidth:"150px"},children:(0,E.jsx)(s.SelectControl,{value:r.qty_rule_type,options:R,onChange:t=>a(e,"qty_rule_type",t),__nextHasNoMarginBottom:!0})}),(0,E.jsx)("td",{style:{minWidth:"100px"},children:(0,E.jsx)(s.TextControl,{value:r.qty_rule_value,onChange:t=>a(e,"qty_rule_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})})]}),T=({isOpen:e,title:t,message:r,onConfirm:a,onCancel:l,isDangerous:n=!1})=>e?(0,E.jsxs)(s.Modal,{title:t,onRequestClose:l,className:"crp-confirm-dialog",children:[(0,E.jsx)("p",{children:r}),(0,E.jsxs)("div",{className:"crp-modal-actions",style:{display:"flex",justifyContent:"flex-end",gap:"10px",marginTop:"20px"},children:[(0,E.jsx)(s.Button,{onClick:l,children:"Cancel"}),(0,E.jsx)(s.Button,{variant:"primary",onClick:a,isDestructive:n,children:"Confirm"})]})]}):null,L=({rules:e,categories:t,isLoading:r,roleFilter:a,onUpdate:n,onBulkUpdate:o,onBulkDelete:i,onRefetch:d})=>{const[u,p]=(0,l.useState)([]),[h,g]=(0,l.useState)(""),[y,x]=(0,l.useState)(""),[m,v]=(0,l.useState)(""),[f,_]=(0,l.useState)(!1),[j,b]=(0,l.useState)(new Map),[C,w]=(0,l.useState)(new Set),[S,L]=(0,l.useState)(!1);(0,l.useEffect)(()=>{const t=new Map;e.forEach(e=>{if(j.has(e.id))t.set(e.id,j.get(e.id));else{const r=e.single_categories?.[0];t.set(e.id,{rule_type:r?.rule?.type||"",rule_value:r?.rule?.value||"",category_value:"",min_quantity:r?.min_qty||0,qty_rule_type:r?.rule?.quantity_type||"",qty_rule_value:r?.rule?.quantity||""})}}),b(t)},[e]);const B=(e,t,r)=>{const a=j.get(e);if(!a)return;const l={...a,[t]:r},s=new Map(j);s.set(e,l),b(s);const n=new Set(C);n.add(e),w(n)},N=(0,l.useMemo)(()=>h?e.filter(e=>{const r=e.single_categories||[];return t.filter(e=>r.includes(e.id)&&e.name.toLowerCase().includes(h.toLowerCase())).length>0}):e,[e,h,t]),D=(e,t)=>{p(t?[...u,e]:u.filter(t=>t!==e))},q=e=>{const t=e.single_categories||[];return 0===t.length?"No categories":t.map(e=>e.name||e.slug||"Unknown").join(", ")||"Unknown"};return r?(0,E.jsx)("div",{style:{display:"flex",justifyContent:"center",padding:"40px"},children:(0,E.jsx)(s.Spinner,{})}):(0,E.jsxs)(E.Fragment,{children:[(0,E.jsxs)("div",{style:{marginBottom:"16px",display:"flex",gap:"10px",alignItems:"flex-end",flexWrap:"wrap"},children:[(0,E.jsx)("div",{style:{flex:"1",minWidth:"200px"},children:(0,E.jsx)(s.TextControl,{label:"Search Categories",value:h,onChange:g,placeholder:"Filter by category name..."})}),u.length>0&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)("div",{style:{minWidth:"150px"},children:(0,E.jsx)(s.SelectControl,{label:"Bulk Rule Type",value:y,options:R,onChange:x})}),(0,E.jsx)(s.Button,{variant:"secondary",onClick:async()=>{0!==u.length&&y&&(await o(u,{rule_type:y}),x(""))},disabled:!y,children:"Apply Type"}),(0,E.jsx)("div",{style:{minWidth:"100px"},children:(0,E.jsx)(s.TextControl,{label:"Bulk Value",value:m,onChange:v,placeholder:"e.g., 10"})}),(0,E.jsx)(s.Button,{variant:"secondary",onClick:async()=>{0!==u.length&&m&&(await o(u,{rule_value:m}),v(""))},disabled:!m,children:"Apply Value"}),(0,E.jsxs)(s.Button,{variant:"secondary",isDestructive:!0,onClick:()=>_(!0),children:["Delete (",u.length,")"]})]})]}),C.size>0&&(0,E.jsxs)("div",{className:"crp-save-banner",children:[(0,E.jsxs)("span",{className:"crp-save-banner__message",children:[(0,E.jsx)("strong",{children:C.size})," unsaved change",1!==C.size?"s":""]}),(0,E.jsxs)("div",{className:"crp-save-banner__actions",children:[(0,E.jsx)(s.Button,{variant:"secondary",onClick:()=>window.location.reload(),disabled:S,children:"Discard Changes"}),(0,E.jsx)(s.Button,{variant:"primary",onClick:async()=>{if(0!==C.size){L(!0);try{for(const t of Array.from(C)){const r=e.find(e=>e.id===t);if(!r)continue;const a=r.single_categories?.map(e=>{const r=j.get(t);return{category_id:e.id,type:r?.rule_type||e.rule?.type||"percentage",value:r?.rule_value||e.rule?.value||"0",min_qty:r?.min_quantity||e.min_qty||0,quantity:r?.qty_rule_value||e.rule?.quantity||"",quantity_type:r?.qty_rule_type||e.rule?.quantity_type||""}})||[];await c()({path:`/rrb2b/v1/rules/${t}/categories`,method:"PUT",data:{rows:a}})}w(new Set),d&&d()}catch(e){console.error("Failed to save changes:",e)}finally{L(!1)}}},isBusy:S,disabled:S,children:"Save All Changes"})]})]}),0===N.length?(0,E.jsx)("div",{style:{padding:"40px",textAlign:"center",background:"#f9f9f9",borderRadius:"4px"},children:(0,E.jsx)("p",{style:{margin:0,color:"#757575"},children:h?"No categories match your search.":"No category rules found."})}):(0,E.jsx)("div",{style:{overflowX:"auto"},children:(0,E.jsxs)("table",{className:"wp-list-table widefat fixed striped",style:{minWidth:"1200px"},children:[(0,E.jsx)("thead",{children:(0,E.jsxs)("tr",{children:[(0,E.jsx)("th",{style:{width:"40px"},children:(0,E.jsx)("input",{type:"checkbox",checked:u.length===N.length&&N.length>0,onChange:()=>{u.length===N.length?p([]):p(N.map(e=>e.id))}})}),(0,E.jsx)("th",{children:"Category"}),(0,E.jsx)("th",{children:"Rule Type"}),(0,E.jsx)("th",{children:"Value"}),(0,E.jsx)("th",{children:"Cat. Value"}),(0,E.jsx)("th",{children:"Min Qty"}),(0,E.jsx)("th",{children:"Qty Rule Type"}),(0,E.jsx)("th",{children:"Qty Value"}),(0,E.jsx)("th",{children:"Actions"})]})}),(0,E.jsx)("tbody",{children:N.map(e=>{const t=j.get(e.id)||{rule_type:"",rule_value:"",category_value:"",min_quantity:0,qty_rule_type:"",qty_rule_value:""};return(0,E.jsx)(k,{ruleId:e.id,categoryName:q(e),formData:t,onChange:B,onSelect:D,isSelected:u.includes(e.id),hasChanges:C.has(e.id)},e.id)})})]})}),(0,E.jsx)(T,{isOpen:f,title:"Delete Selected Rules",message:`Are you sure you want to delete ${u.length} selected rule(s)? This action cannot be undone.`,onConfirm:async()=>{0!==u.length&&(await i(u),p([]),_(!1))},onCancel:()=>_(!1),isDangerous:!0})]})},B=({value:e,onChange:t,roles:r,label:a="Select Role",disabled:l=!1})=>{const n=[{label:"Select Role",value:""},...r.map(e=>({label:e.name,value:e.slug}))];return(0,E.jsx)(s.SelectControl,{label:a,value:e,options:n,onChange:t,disabled:l})},N=({value:e,onChange:t,label:r="Categories"})=>{const{categories:a,isLoading:n}=S(),[o,i]=(0,l.useState)(!1),[c,d]=(0,l.useState)(""),u=(0,l.useMemo)(()=>a.filter(t=>e.includes(t.id)),[a,e]),p=(0,l.useMemo)(()=>c?a.filter(e=>e.name.toLowerCase().includes(c.toLowerCase())):a,[a,c]);return(0,E.jsxs)("div",{className:"crp-category-multiselect",children:[(0,E.jsx)("label",{className:"components-base-control__label",children:r}),(0,E.jsx)("div",{className:"selected-categories",style:{marginBottom:"8px",display:"flex",flexWrap:"wrap",gap:"4px"},children:0===u.length?(0,E.jsx)("span",{style:{color:"#757575",fontSize:"13px"},children:"No categories selected"}):u.map(r=>(0,E.jsxs)("span",{className:"category-tag",style:{display:"inline-flex",alignItems:"center",padding:"4px 8px",background:"#f0f0f0",borderRadius:"4px",fontSize:"12px",gap:"6px"},children:[r.name,(0,E.jsx)("button",{onClick:()=>(r.id,void t(e)),style:{border:"none",background:"transparent",cursor:"pointer",padding:0,fontSize:"14px",lineHeight:1},"aria-label":`Remove ${r.name}`,children:"×"})]},r.id))}),(0,E.jsx)(s.Button,{variant:"secondary",onClick:()=>i(!o),children:o?"Close":"Select Categories"}),o&&(0,E.jsx)(s.Popover,{position:"bottom left",onClose:()=>i(!1),className:"crp-category-popover",children:(0,E.jsxs)("div",{style:{width:"300px",padding:"12px"},children:[(0,E.jsx)(s.TextControl,{label:"Search",value:c,onChange:d,placeholder:"Search categories..."}),n?(0,E.jsx)("p",{children:"Loading categories..."}):(0,E.jsx)("div",{style:{maxHeight:"300px",overflowY:"auto",marginTop:"8px"},children:0===p.length?(0,E.jsx)("p",{style:{color:"#757575",fontSize:"13px"},children:"No categories found"}):p.map(t=>(0,E.jsx)(s.CheckboxControl,{label:t.name,checked:e.includes(t.id),onChange:()=>handleToggle(t.id)},t.id))})]})})]})},D=({roleFilter:e})=>{const[t,r]=(0,l.useState)(""),[a,i]=(0,l.useState)(!1),[d,u]=(0,l.useState)([]),[p,h]=(0,l.useState)(!1),g=e||t,{roles:y,isLoading:x}=(()=>{const[e,t]=(0,l.useState)([]),[r,a]=(0,l.useState)(!1),{createSuccessNotice:s,createErrorNotice:i}=(0,n.useDispatch)(o.store),d=async()=>{a(!0);try{const e=await c()({path:"/rrb2b/v1/roles",method:"GET"});t(e)}catch(e){const t=e instanceof Error?e.message:"Unknown error";i(`Failed to load roles: ${t}`),console.error("Error fetching roles:",e)}finally{a(!1)}};return(0,l.useEffect)(()=>{d()},[]),{roles:e,isLoading:r,createRole:async r=>{try{const a={role_name:r.name,role_slug:r.slug,role_cap:r.baseCap||"customer"},l=(await c()({path:"/rrb2b/v1/roles",method:"POST",data:a})).role;return t([...e,l]),s("Role created successfully!",{type:"snackbar"}),l}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw i(`Failed to create role: ${t}`),e}},deleteRole:async r=>{const a=[...e];t(e.filter(e=>e.slug!==r));try{await c()({path:`/rrb2b/v1/roles/${r}`,method:"DELETE"}),s("Role deleted successfully!",{type:"snackbar"})}catch(e){t(a);const r=e instanceof Error?e.message:"Unknown error";throw i(`Failed to delete role: ${r}`),e}},refetch:d}})(),{categories:m,isLoading:v}=S(),{rules:f,isLoading:_,createRule:j,updateRule:b,bulkUpdate:w,bulkDelete:R,refetch:k}=(e=>{const{rules:t,isLoading:r,error:a}=(0,n.useSelect)(t=>{const r=t(C).getRules();return{rules:e?t(C).getRulesByRole(e):r,isLoading:t(C).isLoading(),error:t(C).getError()}},[e]),{addRule:l,updateRule:s,deleteRule:i,invalidateResolution:d}=(0,n.useDispatch)(C),{createSuccessNotice:u,createErrorNotice:p}=(0,n.useDispatch)(o.store),h=async(e,r)=>{const a=t.find(t=>t.id===e);a&&s({...a,...r});try{const t=await c()({path:`/rrb2b/v1/rules/${e}`,method:"PUT",data:r});return s(t),u("Rule updated successfully!",{type:"snackbar"}),t}catch(e){a&&s(a);const t=e instanceof Error?e.message:"Failed to update rule";throw p(`Failed to update rule: ${t}`),e}},g=async e=>{i(e);try{await c()({path:`/rrb2b/v1/rules/${e}`,method:"DELETE"}),u("Rule deleted successfully!",{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to delete rule";throw p(`Failed to delete rule: ${t}`),e}};return{rules:t,isLoading:r,error:a,createRule:async e=>{try{const t={role_name:e.role},r=await c()({path:"/rrb2b/v1/rules",method:"POST",data:t});(void 0!==e.active||e.rule_type||e.rule_value)&&await c()({path:`/rrb2b/v1/rules/${r.id}`,method:"PUT",data:{rule_active:e.active,global_rule:e.rule_type&&e.rule_value?{type:e.rule_type,value:e.rule_value}:void 0}});const a=await c()({path:`/rrb2b/v1/rules/${r.id}`,method:"GET"});return l(a),u("Rule created successfully!",{type:"snackbar"}),a}catch(e){const t=e instanceof Error?e.message:"Failed to create rule";throw p(`Failed to create rule: ${t}`),e}},updateRule:h,deleteRule:g,toggleActive:async e=>{const r=t.find(t=>t.id===e);r&&await h(e,{rule_active:!r.rule_active})},copyRule:async(e,t)=>{try{(await c()({path:`/rrb2b/v1/rules/${e}/copy`,method:"POST",data:{destination_roles:t}})).forEach(e=>l(e)),u(`Rule copied to ${t.length} role(s) successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to copy rule";throw p(`Failed to copy rule: ${t}`),e}},bulkUpdate:async(e,t)=>{try{const r=e.map(e=>h(e,t));await Promise.all(r),u(`${e.length} rule(s) updated successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to bulk update";throw p(`Bulk update failed: ${t}`),e}},bulkDelete:async e=>{try{const t=e.map(e=>g(e));await Promise.all(t),u(`${e.length} rule(s) deleted successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to bulk delete";throw p(`Bulk delete failed: ${t}`),e}},refetch:()=>{d("getRules")}}})(g),T=f.filter(e=>e.single_categories&&e.single_categories.length>0);return(0,E.jsxs)("div",{className:"crp-categories-tab",children:[!e&&(0,E.jsxs)(E.Fragment,{children:[(0,E.jsxs)("div",{style:{marginBottom:"20px"},children:[(0,E.jsx)("h2",{children:"Category Pricing Rules"}),(0,E.jsx)("p",{children:"Configure role-based pricing rules for specific product categories."})]}),(0,E.jsx)("div",{style:{marginBottom:"20px"},children:(0,E.jsx)(B,{value:g,onChange:r,roles:y,label:"Filter by Role",disabled:x})})]}),(0,E.jsx)("div",{style:{marginBottom:"20px"},children:(0,E.jsx)(s.Button,{variant:"secondary",onClick:()=>i(!a),disabled:!g&&!e,children:a?"Cancel":"+ Add Category Rules"})}),a&&(0,E.jsx)(s.Card,{style:{marginBottom:"20px"},children:(0,E.jsxs)(s.CardBody,{children:[(0,E.jsx)("h3",{children:"Add Category Rules"}),(0,E.jsx)(N,{value:d,onChange:u}),(0,E.jsxs)("div",{style:{marginTop:"15px",display:"flex",gap:"10px"},children:[(0,E.jsx)(s.Button,{variant:"primary",onClick:async()=>{if(g&&0!==d.length){h(!0);try{const e=f.find(e=>e.role_name===g);if(e){const t=[...(e.single_categories||[]).map(e=>({category_id:e.id,type:e.rule?.type||"percentage",value:e.rule?.value||"0",min_qty:e.min_qty||0})),...d.map(e=>({category_id:e,type:"percentage",value:"0",min_qty:0}))];await c()({path:`/rrb2b/v1/rules/${e.id}/categories`,method:"PUT",data:{rows:t}}),k()}else await j({role:g,rule_type:"percentage",rule_value:"0",active:!0,single_categories:d});u([]),i(!1)}catch(e){console.error("Failed to add category rules:",e)}finally{h(!1)}}},isBusy:p,disabled:0===d.length||p,children:"Add Selected Categories"}),(0,E.jsx)(s.Button,{variant:"tertiary",onClick:()=>i(!1),children:"Cancel"})]}),(0,E.jsx)("p",{style:{marginTop:"10px",fontSize:"13px",color:"#757575"},children:"Select categories and configure pricing rules in the table below."})]})}),(0,E.jsx)(L,{rules:T,categories:m,isLoading:_||v,roleFilter:g,onUpdate:b,onBulkUpdate:w,onBulkDelete:R,onRefetch:k})]})};class q extends l.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("React Error:",e,t)}render(){return this.state.hasError?(0,E.jsxs)("div",{className:"notice notice-error",style:{padding:"20px",margin:"20px 0"},children:[(0,E.jsx)("h3",{children:"Something went wrong"}),(0,E.jsx)("p",{children:"The admin interface encountered an error. Please refresh the page to try again."}),this.state.error&&(0,E.jsxs)("details",{style:{marginTop:"10px"},children:[(0,E.jsx)("summary",{children:"Error details"}),(0,E.jsx)("pre",{style:{marginTop:"10px",padding:"10px",background:"#f5f5f5",overflow:"auto"},children:this.state.error.toString()})]})]}):this.props.children}}const F=q,U=()=>{const e=document.getElementById("crp-categories-root");e&&(0,l.createRoot)(e).render((0,l.createElement)(F,null,(0,l.createElement)(D)))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",U):U()})();
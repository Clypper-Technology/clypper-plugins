(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{addRule:()=>m,deleteRule:()=>g,setError:()=>E,setLoading:()=>y,setRules:()=>p,updateRule:()=>h});var r={};e.r(r),e.d(r,{getError:()=>w,getRuleById:()=>v,getRules:()=>_,getRulesByRole:()=>f,isLoading:()=>b});var a={};e.r(a),e.d(a,{getRules:()=>S});const l=window.wp.element,n=window.React,c=window.wp.components,o=window.wp.data,s=window.wp.notices,i=window.wp.apiFetch;var u=e.n(i);const d={rules:[],isLoading:!1,error:null},p=e=>({type:"SET_RULES",rules:e}),m=e=>({type:"ADD_RULE",rule:e}),h=e=>({type:"UPDATE_RULE",rule:e}),g=e=>({type:"DELETE_RULE",id:e}),y=e=>({type:"SET_LOADING",isLoading:e}),E=e=>({type:"SET_ERROR",error:e}),_=e=>e.rules,v=(e,t)=>e.rules.find(e=>e.id===t),f=(0,o.createSelector)([e=>e.rules,(e,t)=>t],(e,t)=>t?e.filter(e=>e.role_name===t):e),b=e=>e.isLoading,w=e=>e.error,S=()=>async({dispatch:e})=>{e(y(!0));try{const t=await u()({path:"/rrb2b/v1/rules"});e(p(t))}catch(t){const r=t instanceof Error?t.message:"Failed to load rules";e(E(r)),console.error("Error fetching rules:",t)}finally{e(y(!1))}},C="rrb2b/rules",x=(0,o.createReduxStore)(C,{reducer:(e=d,t)=>{switch(t.type){case"SET_RULES":return{...e,rules:t.rules,error:null};case"ADD_RULE":return{...e,rules:[...e.rules,t.rule]};case"UPDATE_RULE":return{...e,rules:e.rules.map(e=>e.id===t.rule.id?t.rule:e)};case"DELETE_RULE":return{...e,rules:e.rules.filter(e=>e.id!==t.id)};case"SET_LOADING":return{...e,isLoading:t.isLoading};case"SET_ERROR":return{...e,error:t.error};default:return e}},actions:t,selectors:r,resolvers:a});(0,o.register)(x);const k=()=>{const[e,t]=(0,l.useState)([]),[r,a]=(0,l.useState)(!1),n=async()=>{a(!0);try{const e=await u()({path:"/wc/v3/products/categories?per_page=100"});t(e)}catch(e){console.error("Error fetching categories:",e),t([])}finally{a(!1)}};return(0,l.useEffect)(()=>{n()},[]),{categories:e,isLoading:r,fetchCategories:n}},R=[{label:"Select Type",value:""},{label:"Percentage Discount",value:"percentage"},{label:"Fixed Amount Discount",value:"fixed"},{label:"Fixed Price",value:"fixed_price"},{label:"Hide Price",value:"hide_price"}],N=({ruleId:e,product:t,formData:r,onChange:a,onSelect:l,isSelected:o,hasChanges:s})=>{const i=["crp-product-row",o&&"selected-row",s&&"has-changes"].filter(Boolean).join(" ");return(0,n.createElement)("tr",{className:i},(0,n.createElement)("td",{className:"crp-table__checkbox-cell"},(0,n.createElement)(c.CheckboxControl,{checked:o,onChange:t=>l(e,t),__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",{className:"crp-product-row__thumbnail-cell"},t?.thumbnail&&(0,n.createElement)("img",{src:t.thumbnail,alt:t.name,className:"crp-product-row__thumbnail"})),(0,n.createElement)("td",{className:"crp-product-row__name-cell"},(0,n.createElement)("strong",null,t?.name||"Unknown Product"),t?.sku&&(0,n.createElement)("div",{className:"crp-product-row__sku"},"SKU: ",t.sku),s&&(0,n.createElement)("div",{className:"crp-product-row__unsaved-indicator"},"● Unsaved changes")),(0,n.createElement)("td",null,(0,n.createElement)(c.SelectControl,{value:r.rule_type,options:R,onChange:t=>a(e,"rule_type",t),__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",null,(0,n.createElement)(c.TextControl,{value:r.rule_value,onChange:t=>a(e,"rule_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",null,(0,n.createElement)(c.TextControl,{value:String(r.min_quantity),onChange:t=>a(e,"min_quantity",parseInt(t)||0),placeholder:"0",type:"number",__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",null,(0,n.createElement)(c.SelectControl,{value:r.qty_rule_type,options:R,onChange:t=>a(e,"qty_rule_type",t),__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",null,(0,n.createElement)(c.TextControl,{value:r.qty_rule_value,onChange:t=>a(e,"qty_rule_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})))},T=({isOpen:e,title:t,message:r,onConfirm:a,onCancel:l,isDangerous:o=!1})=>e?(0,n.createElement)(c.Modal,{title:t,onRequestClose:l,className:"crp-confirm-dialog"},(0,n.createElement)("p",null,r),(0,n.createElement)("div",{className:"crp-modal-actions",style:{display:"flex",justifyContent:"flex-end",gap:"10px",marginTop:"20px"}},(0,n.createElement)(c.Button,{onClick:l},"Cancel"),(0,n.createElement)(c.Button,{variant:"primary",onClick:a,isDestructive:o},"Confirm"))):null,P=({rules:e,products:t,isLoading:r,roleFilter:a,onUpdate:o,onBulkUpdate:s,onBulkDelete:i,onAddProduct:d,onRefetch:p})=>{const[m,h]=(0,l.useState)([]),[g,y]=(0,l.useState)(""),[E,_]=(0,l.useState)(""),[v,f]=(0,l.useState)(""),[b,w]=(0,l.useState)(!1),[S,C]=(0,l.useState)(new Map),[x,k]=(0,l.useState)(new Set),[P,L]=(0,l.useState)(!1);(0,l.useEffect)(()=>{const t=new Map;e.forEach(e=>{if(S.has(e.id))t.set(e.id,S.get(e.id));else{const r=e.products?.[0];t.set(e.id,{rule_type:r?.rule?.type||"",rule_value:r?.rule?.value||"",min_quantity:r?.min_qty||0,qty_rule_type:r?.rule?.quantity_type||"",qty_rule_value:r?.rule?.quantity||""})}}),C(t)},[e]);const B=(0,l.useMemo)(()=>g?e.filter(e=>(e.products||[]).some(e=>{const r=g.toLowerCase();if(e.name&&e.name.toLowerCase().includes(r))return!0;const a=t.get(e.id);return!(!a?.sku||!a.sku.toLowerCase().includes(r))})):e,[e,g,t]),D=(e,t)=>{h(t?[...m,e]:m.filter(t=>t!==e))},F=(e,t,r)=>{const a=S.get(e);if(!a)return;const l={...a,[t]:r},n=new Map(S);n.set(e,l),C(n);const c=new Set(x);c.add(e),k(c)};return r?(0,n.createElement)("div",{style:{display:"flex",justifyContent:"center",padding:"40px"}},(0,n.createElement)(c.Spinner,null)):(0,n.createElement)(n.Fragment,null,(0,n.createElement)("div",{style:{marginBottom:"16px"}},(0,n.createElement)("div",{style:{maxWidth:"300px"}},(0,n.createElement)(c.TextControl,{label:"Filter Existing Rules",value:g,onChange:y,placeholder:"Filter by product name or SKU...",help:"Search within the table below"}))),m.length>0&&(0,n.createElement)("div",{style:{marginBottom:"16px"}},(0,n.createElement)("div",{style:{display:"flex",gap:"10px",alignItems:"flex-end",flexWrap:"wrap"}},(0,n.createElement)("div",{style:{minWidth:"150px"}},(0,n.createElement)(c.SelectControl,{label:"Bulk Rule Type",value:E,options:R,onChange:_})),(0,n.createElement)(c.Button,{variant:"secondary",onClick:async()=>{0!==m.length&&E&&(await s(m,{rule_type:E}),_(""))},disabled:!E},"Apply Type"),(0,n.createElement)("div",{style:{minWidth:"100px"}},(0,n.createElement)(c.TextControl,{label:"Bulk Value",value:v,onChange:f,placeholder:"e.g., 10"})),(0,n.createElement)(c.Button,{variant:"secondary",onClick:async()=>{0!==m.length&&v&&(await s(m,{rule_value:v}),f(""))},disabled:!v},"Apply Value"),(0,n.createElement)(c.Button,{variant:"secondary",isDestructive:!0,onClick:()=>w(!0)},"Delete (",m.length,")"))),x.size>0&&(0,n.createElement)("div",{className:"crp-save-banner"},(0,n.createElement)("span",{className:"crp-save-banner__message"},(0,n.createElement)("strong",null,x.size)," unsaved change",1!==x.size?"s":""),(0,n.createElement)("div",{className:"crp-save-banner__actions"},(0,n.createElement)(c.Button,{variant:"secondary",onClick:()=>window.location.reload(),disabled:P},"Discard Changes"),(0,n.createElement)(c.Button,{variant:"primary",onClick:async()=>{if(0!==x.size){L(!0);try{for(const t of Array.from(x)){const r=e.find(e=>e.id===t);if(!r)continue;const a=r.products?.map(e=>{const r=S.get(t);return{product_id:e.id,product_name:e.name,type:r?.rule_type||e.rule?.type||"percentage",value:r?.rule_value||e.rule?.value||"0",min_qty:r?.min_quantity||e.min_qty||1,quantity:r?.qty_rule_value||e.rule?.quantity||"",quantity_type:r?.qty_rule_type||e.rule?.quantity_type||""}})||[];await u()({path:`/rrb2b/v1/rules/${t}/products`,method:"PUT",data:{rows:a}})}k(new Set),p&&p()}catch(e){console.error("Failed to save changes:",e)}finally{L(!1)}}},isBusy:P,disabled:P},"Save All Changes"))),0===B.length?(0,n.createElement)("div",{className:"crp-empty-state"},(0,n.createElement)("p",{className:"crp-empty-state__text"},g?"No products match your search.":"No product rules found. Add products using the search above.")):(0,n.createElement)("div",{className:"crp-table-container"},(0,n.createElement)("table",{className:"wp-list-table widefat fixed striped crp-table"},(0,n.createElement)("thead",null,(0,n.createElement)("tr",null,(0,n.createElement)("th",{style:{width:"40px"}},(0,n.createElement)("input",{type:"checkbox",checked:m.length===B.length&&B.length>0,onChange:()=>{m.length===B.length?h([]):h(B.map(e=>e.id))}})),(0,n.createElement)("th",{style:{width:"60px"}},"Image"),(0,n.createElement)("th",null,"Product"),(0,n.createElement)("th",null,"Rule Type"),(0,n.createElement)("th",null,"Value"),(0,n.createElement)("th",null,"Minimum Quantity"),(0,n.createElement)("th",null,"Quantity Rule Type"),(0,n.createElement)("th",null,"Quantity Value"))),(0,n.createElement)("tbody",null,B.map(e=>{const r=e.products?.[0],a=r?{id:r.id,name:r.name,sku:"",thumbnail:t.get(r.id)?.thumbnail||""}:null,l=S.get(e.id)||{rule_type:"",rule_value:"",min_quantity:0,qty_rule_type:"",qty_rule_value:""};return(0,n.createElement)(N,{key:e.id,ruleId:e.id,product:a,formData:l,onChange:F,onSelect:D,isSelected:m.includes(e.id),hasChanges:x.has(e.id)})})))),(0,n.createElement)(T,{isOpen:b,title:"Delete Selected Rules",message:`Are you sure you want to delete ${m.length} selected rule(s)? This action cannot be undone.`,onConfirm:async()=>{0!==m.length&&(await i(m),h([]),w(!1))},onCancel:()=>w(!1),isDangerous:!0}))},L=window.wp.compose,B=({onSelect:e,ruleId:t,placeholder:r="Search products..."})=>{const[a,o]=(0,l.useState)(""),[s,i]=(0,l.useState)([]),[d,p]=(0,l.useState)(!1),[m,h]=(0,l.useState)(!1),{searchProducts:g}=(()=>{const[e,t]=(0,l.useState)(!1);return{searchProducts:async(e,r)=>{if(!e||e.length<2)return[];t(!0);try{return r?await u()({path:`/rrb2b/v1/rules/${r}/products/search`,method:"POST",data:{search:e}}):(await u()({path:`/wc/v3/products?search=${encodeURIComponent(e)}&per_page=20`})).map(e=>({id:e.id,name:e.name,sku:e.sku,price:e.price,thumbnail:e.images?.[0]?.src||""}))}catch(e){return console.error("Error searching products:",e),[]}finally{t(!1)}},getProductsByCategory:async e=>{t(!0);try{return(await u()({path:`/wc/v3/products?category=${e}&per_page=100`})).map(e=>({id:e.id,name:e.name,sku:e.sku,price:e.price,thumbnail:e.images?.[0]?.src||""}))}catch(e){return console.error("Error fetching products by category:",e),[]}finally{t(!1)}},isSearching:e}})(),y=(0,l.useMemo)(()=>(0,L.debounce)(async e=>{if(e.length<2)return i([]),void h(!1);h(!0);const r=await g(e,t);i(r),p(!0),h(!1)},300),[t,g]);return(0,l.useEffect)(()=>{a.length>=2&&h(!0),y(a)},[a,y]),(0,n.createElement)("div",{className:"crp-product-search"},(0,n.createElement)(c.TextControl,{label:"Search Products",value:a,onChange:o,placeholder:r,autoComplete:"off"}),m&&(0,n.createElement)("div",{className:"crp-product-search__spinner"},(0,n.createElement)(c.Spinner,null)),d&&s.length>0&&(0,n.createElement)("div",{className:"crp-product-search__results"},s.map(t=>(0,n.createElement)("button",{key:t.id,onClick:()=>(t=>{e(t),o(""),i([]),p(!1)})(t),className:"crp-product-search__result-item"},t.thumbnail&&(0,n.createElement)("img",{src:t.thumbnail,alt:t.name,className:"crp-product-search__result-thumbnail"}),(0,n.createElement)("div",{className:"crp-product-search__result-details"},(0,n.createElement)("div",{className:"crp-product-search__result-name"},t.name),t.sku&&(0,n.createElement)("div",{className:"crp-product-search__result-sku"},"SKU: ",t.sku)),t.price&&(0,n.createElement)("div",{className:"crp-product-search__result-price"},"$",t.price)))),a.length>=2&&0===s.length&&!m&&(0,n.createElement)("div",{className:"crp-product-search__no-results"},"No products found"))},D=({value:e,onChange:t,label:r="Categories"})=>{const{categories:a,isLoading:o}=k(),[s,i]=(0,l.useState)(!1),[u,d]=(0,l.useState)(""),p=(0,l.useMemo)(()=>a.filter(t=>e.includes(t.id)),[a,e]),m=(0,l.useMemo)(()=>u?a.filter(e=>e.name.toLowerCase().includes(u.toLowerCase())):a,[a,u]);return(0,n.createElement)("div",{className:"crp-category-multiselect"},(0,n.createElement)("label",{className:"components-base-control__label"},r),(0,n.createElement)("div",{className:"selected-categories",style:{marginBottom:"8px",display:"flex",flexWrap:"wrap",gap:"4px"}},0===p.length?(0,n.createElement)("span",{style:{color:"#757575",fontSize:"13px"}},"No categories selected"):p.map(r=>(0,n.createElement)("span",{key:r.id,className:"category-tag",style:{display:"inline-flex",alignItems:"center",padding:"4px 8px",background:"#f0f0f0",borderRadius:"4px",fontSize:"12px",gap:"6px"}},r.name,(0,n.createElement)("button",{onClick:()=>{return a=r.id,void t(e.filter(e=>e!==a));var a},style:{border:"none",background:"transparent",cursor:"pointer",padding:0,fontSize:"14px",lineHeight:1},"aria-label":`Remove ${r.name}`},"×")))),(0,n.createElement)(c.Button,{variant:"secondary",onClick:()=>i(!s)},s?"Close":"Select Categories"),s&&(0,n.createElement)(c.Popover,{position:"bottom left",onClose:()=>i(!1),className:"crp-category-popover"},(0,n.createElement)("div",{style:{width:"300px",padding:"12px"}},(0,n.createElement)(c.TextControl,{label:"Search",value:u,onChange:d,placeholder:"Search categories..."}),o?(0,n.createElement)("p",null,"Loading categories..."):(0,n.createElement)("div",{style:{maxHeight:"300px",overflowY:"auto",marginTop:"8px"}},0===m.length?(0,n.createElement)("p",{style:{color:"#757575",fontSize:"13px"}},"No categories found"):m.map(r=>(0,n.createElement)(c.CheckboxControl,{key:r.id,label:r.name,checked:e.includes(r.id),onChange:()=>{return a=r.id,void(e.includes(a)?t(e.filter(e=>e!==a)):t([...e,a]));var a}}))))))},F=({isOpen:e,onClose:t,onAddProduct:r,onAddFromCategory:a,categories:o})=>{const[s,i]=(0,l.useState)([]),[d,p]=(0,l.useState)(!1),[m,h]=(0,l.useState)(!1),[g,y]=(0,l.useState)([]),[E,_]=(0,l.useState)(!1);(0,l.useEffect)(()=>{e&&0===g.length&&v()},[e]);const v=async()=>{_(!0);try{const e=(await u()({path:"/wc/v3/products?per_page=10&orderby=popularity&order=desc"})).map(e=>({id:e.id,name:e.name,sku:e.sku,price:e.price,thumbnail:e.images?.[0]?.src||""}));y(e)}catch(e){console.error("Failed to load suggested products:",e)}finally{_(!1)}},f=async()=>{if(0!==s.length){h(!0);try{await a(s,d),i([]),p(!1),t()}catch(e){console.error("Failed to add products from category:",e)}finally{h(!1)}}},b=async e=>{h(!0);try{await r(e),t()}catch(e){console.error("Failed to add product:",e)}finally{h(!1)}};return e?(0,n.createElement)(c.Modal,{title:"Add Product Rules",onRequestClose:t,className:"crp-add-product-modal"},(0,n.createElement)(c.TabPanel,{className:"crp-add-product-tabs",tabs:[{name:"search",title:"Add Products"},{name:"category",title:"Add from Category"}]},e=>"search"===e.name?(0,n.createElement)("div",{className:"crp-add-product-tabs"},(0,n.createElement)("p",{className:"crp-modal__description"},"Search and select products to add pricing rules."),(0,n.createElement)(B,{onSelect:b,placeholder:"Search for products..."}),E?(0,n.createElement)("div",{style:{padding:"20px",textAlign:"center"}},(0,n.createElement)(c.Spinner,null),(0,n.createElement)("p",null,"Loading suggested products...")):g.length>0&&(0,n.createElement)("div",{style:{marginTop:"20px"}},(0,n.createElement)("h4",null,"Suggested Products"),(0,n.createElement)("div",{style:{display:"grid",gap:"8px"}},g.map(e=>(0,n.createElement)("button",{key:e.id,onClick:()=>b(e),className:"crp-product-search__result-item",style:{border:"1px solid #ddd",borderRadius:"4px"}},e.thumbnail&&(0,n.createElement)("img",{src:e.thumbnail,alt:e.name,className:"crp-product-search__result-thumbnail"}),(0,n.createElement)("div",{className:"crp-product-search__result-details"},(0,n.createElement)("div",{className:"crp-product-search__result-name"},e.name),e.sku&&(0,n.createElement)("div",{className:"crp-product-search__result-sku"},"SKU: ",e.sku)),e.price&&(0,n.createElement)("div",{className:"crp-product-search__result-price"},"$",e.price)))))):(0,n.createElement)("div",{className:"crp-add-product-tabs"},(0,n.createElement)("p",{className:"crp-modal__description"},"Select categories to add all products from those categories."),o.length>0&&(0,n.createElement)("div",{style:{marginBottom:"15px"}},(0,n.createElement)("h4",null,"Suggested Categories"),(0,n.createElement)("div",{style:{display:"flex",flexWrap:"wrap",gap:"8px"}},o.slice(0,6).map(e=>(0,n.createElement)(c.Button,{key:e.id,variant:"secondary",size:"small",onClick:()=>{s.includes(e.id)||i([...s,e.id])},disabled:s.includes(e.id)},e.name)))),(0,n.createElement)(D,{value:s,onChange:i}),(0,n.createElement)("div",{className:"crp-modal__checkbox-label"},(0,n.createElement)("label",null,(0,n.createElement)("input",{type:"checkbox",checked:d,onChange:e=>p(e.target.checked),className:"crp-modal__checkbox-input"}),"Include product variations")),(0,n.createElement)("div",{className:"crp-modal__actions"},(0,n.createElement)(c.Button,{variant:"primary",onClick:f,isBusy:m,disabled:0===s.length||m},"Add Products from Categories"),(0,n.createElement)(c.Button,{variant:"tertiary",onClick:t,disabled:m},"Cancel"))))):null},U=({value:e,onChange:t,roles:r,label:a="Select Role",disabled:l=!1})=>{const o=[{label:"Select Role",value:""},...r.map(e=>({label:e.name,value:e.slug}))];return(0,n.createElement)(c.SelectControl,{label:a,value:e,options:o,onChange:t,disabled:l})},q=({roleFilter:e})=>{const[t,r]=(0,l.useState)(""),[a,i]=(0,l.useState)(!1),d=e||t,{roles:p,isLoading:m}=(()=>{const[e,t]=(0,l.useState)([]),[r,a]=(0,l.useState)(!1),{createSuccessNotice:n,createErrorNotice:c}=(0,o.useDispatch)(s.store),i=async()=>{a(!0);try{const e=await u()({path:"/rrb2b/v1/roles",method:"GET"});t(e)}catch(e){const t=e instanceof Error?e.message:"Unknown error";c(`Failed to load roles: ${t}`),console.error("Error fetching roles:",e)}finally{a(!1)}};return(0,l.useEffect)(()=>{i()},[]),{roles:e,isLoading:r,createRole:async r=>{try{const a={role_name:r.name,role_slug:r.slug,role_cap:r.baseCap||"customer"},l=(await u()({path:"/rrb2b/v1/roles",method:"POST",data:a})).role;return t([...e,l]),n("Role created successfully!",{type:"snackbar"}),l}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw c(`Failed to create role: ${t}`),e}},deleteRole:async r=>{const a=[...e];t(e.filter(e=>e.slug!==r));try{await u()({path:`/rrb2b/v1/roles/${r}`,method:"DELETE"}),n("Role deleted successfully!",{type:"snackbar"})}catch(e){t(a);const r=e instanceof Error?e.message:"Unknown error";throw c(`Failed to delete role: ${r}`),e}},refetch:i}})(),{categories:h,isLoading:g}=k(),{rules:y,isLoading:E,createRule:_,updateRule:v,bulkUpdate:f,bulkDelete:b,refetch:w}=(e=>{const{rules:t,isLoading:r,error:a}=(0,o.useSelect)(t=>{const r=t(C).getRules();return{rules:e?t(C).getRulesByRole(e):r,isLoading:t(C).isLoading(),error:t(C).getError()}},[e]),{addRule:l,updateRule:n,deleteRule:c,invalidateResolution:i}=(0,o.useDispatch)(C),{createSuccessNotice:d,createErrorNotice:p}=(0,o.useDispatch)(s.store),m=async(e,r)=>{const a=t.find(t=>t.id===e);a&&n({...a,...r});try{const t=await u()({path:`/rrb2b/v1/rules/${e}`,method:"PUT",data:r});return n(t),d("Rule updated successfully!",{type:"snackbar"}),t}catch(e){a&&n(a);const t=e instanceof Error?e.message:"Failed to update rule";throw p(`Failed to update rule: ${t}`),e}},h=async e=>{c(e);try{await u()({path:`/rrb2b/v1/rules/${e}`,method:"DELETE"}),d("Rule deleted successfully!",{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to delete rule";throw p(`Failed to delete rule: ${t}`),e}};return{rules:t,isLoading:r,error:a,createRule:async e=>{try{const t={role_name:e.role},r=await u()({path:"/rrb2b/v1/rules",method:"POST",data:t});if(e.products&&e.products.length>0){const t=e.products.map((t,r)=>{const a=e.productDetails?.[r];return{product_id:t,product_name:a?.name||"",type:e.rule_type||"percentage",value:e.rule_value||"0",min_qty:1}});await u()({path:`/rrb2b/v1/rules/${r.id}/products`,method:"PUT",data:{rows:t}})}if(e.single_categories&&e.single_categories.length>0){const t=e.single_categories.map(t=>({category_id:t,type:e.rule_type||"percentage",value:e.rule_value||"0",min_qty:0}));await u()({path:`/rrb2b/v1/rules/${r.id}/categories`,method:"PUT",data:{rows:t}})}(void 0!==e.active||e.rule_type||e.rule_value)&&await u()({path:`/rrb2b/v1/rules/${r.id}`,method:"PUT",data:{rule_active:e.active,global_rule:e.rule_type&&e.rule_value?{type:e.rule_type,value:e.rule_value}:void 0}});const a=await u()({path:`/rrb2b/v1/rules/${r.id}`,method:"GET"});return l(a),d("Rule created successfully!",{type:"snackbar"}),a}catch(e){const t=e instanceof Error?e.message:"Failed to create rule";throw p(`Failed to create rule: ${t}`),e}},updateRule:m,deleteRule:h,toggleActive:async e=>{const r=t.find(t=>t.id===e);r&&await m(e,{rule_active:!r.rule_active})},copyRule:async(e,t)=>{try{(await u()({path:`/rrb2b/v1/rules/${e}/copy`,method:"POST",data:{destination_roles:t}})).forEach(e=>l(e)),d(`Rule copied to ${t.length} role(s) successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to copy rule";throw p(`Failed to copy rule: ${t}`),e}},bulkUpdate:async(e,t)=>{try{const r=e.map(e=>m(e,t));await Promise.all(r),d(`${e.length} rule(s) updated successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to bulk update";throw p(`Bulk update failed: ${t}`),e}},bulkDelete:async e=>{try{const t=e.map(e=>h(e));await Promise.all(t),d(`${e.length} rule(s) deleted successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to bulk delete";throw p(`Bulk delete failed: ${t}`),e}},refetch:()=>{i("getRules")}}})(d),[S,x]=(0,l.useState)(new Map),R=y.filter(e=>e.products&&e.products.length>0);(0,l.useEffect)(()=>{R.length>0&&(async()=>{const e=new Set;R.forEach(t=>{t.products?.forEach(t=>e.add(t.id))});const t=new Map(S),r=Array.from(e).filter(e=>!t.has(e));if(r.length>0)try{for(let e=0;e<r.length;e+=20){const a=r.slice(e,e+20);(await u()({path:`/wc/v3/products?include=${a.join(",")}`})).forEach(e=>{t.set(e.id,{id:e.id,name:e.name,sku:e.sku,price:e.price,thumbnail:e.images?.[0]?.src||""})})}x(t)}catch(e){console.error("Failed to fetch products:",e)}})()},[R.length]);const N=async e=>{if(!d)throw new Error("Please select a role first");const t=y.find(e=>e.role_name===d);if(t){const r=[...(t.products||[]).map(e=>({product_id:e.id,product_name:e.name||"",type:e.rule?.type||"percentage",value:e.rule?.value||"0",min_qty:e.min_qty||1})),{product_id:e.id,product_name:e.name,type:"percentage",value:"0",min_qty:1}];await u()({path:`/rrb2b/v1/rules/${t.id}/products`,method:"PUT",data:{rows:r}}),w()}else await _({role:d,rule_type:"percentage",rule_value:"0",active:!0,products:[e.id],productDetails:[{id:e.id,name:e.name}]});x(t=>new Map(t).set(e.id,e))};return(0,n.createElement)("div",{className:"crp-products-tab"},!e&&(0,n.createElement)(n.Fragment,null,(0,n.createElement)("div",{style:{marginBottom:"20px"}},(0,n.createElement)("h2",null,"Product Pricing Rules"),(0,n.createElement)("p",null,"Configure role-based pricing rules for specific products.")),(0,n.createElement)("div",{style:{marginBottom:"20px"}},(0,n.createElement)(U,{value:d,onChange:r,roles:p,label:"Filter by Role",disabled:m}))),(0,n.createElement)("div",{style:{marginBottom:"20px"}},(0,n.createElement)(c.Button,{variant:"secondary",onClick:()=>i(!0),disabled:!d&&!e},"+ Add Product Rules")),(0,n.createElement)(F,{isOpen:a,onClose:()=>i(!1),onAddProduct:N,onAddFromCategory:async(e,t)=>{if(!d)throw new Error("Please select a role first");const r=y.find(e=>e.role_name===d);if(!r)throw new Error("Please create a rule for this role first");await u()({path:`/rrb2b/v1/rules/${r.id}/products/from-category`,method:"POST",data:{category:e[0],variations:t}}),w()},categories:h}),(0,n.createElement)(P,{rules:R,products:S,isLoading:E,roleFilter:d,onUpdate:v,onBulkUpdate:f,onBulkDelete:b,onAddProduct:N,onRefetch:w}))};class $ extends l.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("React Error:",e,t)}render(){return this.state.hasError?(0,n.createElement)("div",{className:"notice notice-error",style:{padding:"20px",margin:"20px 0"}},(0,n.createElement)("h3",null,"Something went wrong"),(0,n.createElement)("p",null,"The admin interface encountered an error. Please refresh the page to try again."),this.state.error&&(0,n.createElement)("details",{style:{marginTop:"10px"}},(0,n.createElement)("summary",null,"Error details"),(0,n.createElement)("pre",{style:{marginTop:"10px",padding:"10px",background:"#f5f5f5",overflow:"auto"}},this.state.error.toString()))):this.props.children}}const A=$,M=()=>{const e=document.getElementById("crp-products-root");e&&(0,l.createRoot)(e).render((0,l.createElement)(A,null,(0,l.createElement)(q)))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",M):M()})();
(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{addRule:()=>m,deleteRule:()=>y,setError:()=>E,setLoading:()=>h,setRules:()=>p,updateRule:()=>g});var a={};e.r(a),e.d(a,{getError:()=>x,getRuleById:()=>_,getRules:()=>v,getRulesByRole:()=>f,isLoading:()=>b});var r={};e.r(r),e.d(r,{getRules:()=>w});const l=window.wp.element,n=window.React,o=window.wp.components,s=window.wp.data,c=window.wp.notices,i=window.wp.apiFetch;var u=e.n(i);const d={rules:[],isLoading:!1,error:null},p=e=>({type:"SET_RULES",rules:e}),m=e=>({type:"ADD_RULE",rule:e}),g=e=>({type:"UPDATE_RULE",rule:e}),y=e=>({type:"DELETE_RULE",id:e}),h=e=>({type:"SET_LOADING",isLoading:e}),E=e=>({type:"SET_ERROR",error:e}),v=e=>e.rules,_=(e,t)=>e.rules.find(e=>e.id===t),f=(0,s.createSelector)([e=>e.rules,(e,t)=>t],(e,t)=>t?e.filter(e=>e.role_name===t):e),b=e=>e.isLoading,x=e=>e.error,w=()=>async({dispatch:e})=>{e(h(!0));try{const t=await u()({path:"/rrb2b/v1/rules"});e(p(t))}catch(t){const a=t instanceof Error?t.message:"Failed to load rules";e(E(a)),console.error("Error fetching rules:",t)}finally{e(h(!1))}},C="rrb2b/rules",S=(0,s.createReduxStore)(C,{reducer:(e=d,t)=>{switch(t.type){case"SET_RULES":return{...e,rules:t.rules,error:null};case"ADD_RULE":return{...e,rules:[...e.rules,t.rule]};case"UPDATE_RULE":return{...e,rules:e.rules.map(e=>e.id===t.rule.id?t.rule:e)};case"DELETE_RULE":return{...e,rules:e.rules.filter(e=>e.id!==t.id)};case"SET_LOADING":return{...e,isLoading:t.isLoading};case"SET_ERROR":return{...e,error:t.error};default:return e}},actions:t,selectors:a,resolvers:r});(0,s.register)(S);const R=()=>{const[e,t]=(0,l.useState)([]),[a,r]=(0,l.useState)(!1),n=async()=>{r(!0);try{const e=await u()({path:"/wc/v3/products/categories?per_page=100"});t(e)}catch(e){console.error("Error fetching categories:",e),t([])}finally{r(!1)}};return(0,l.useEffect)(()=>{n()},[]),{categories:e,isLoading:a,fetchCategories:n}},k=[{label:"Select Type",value:""},{label:"Percentage Discount",value:"percentage"},{label:"Fixed Amount Discount",value:"fixed"},{label:"Fixed Price",value:"fixed_price"},{label:"Hide Price",value:"hide_price"}],T=({ruleId:e,categoryName:t,formData:a,onChange:r,onSelect:l,isSelected:s,hasChanges:c})=>(0,n.createElement)("tr",{className:`${s?"selected-row":""} ${c?"has-changes":""}`},(0,n.createElement)("td",{style:{width:"40px",textAlign:"center"}},(0,n.createElement)(o.CheckboxControl,{checked:s,onChange:t=>l(e,t),__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",{style:{minWidth:"150px"}},(0,n.createElement)("strong",null,t),c&&(0,n.createElement)("div",{style:{fontSize:"11px",color:"#d63638",marginTop:"4px"}},"● Unsaved changes")),(0,n.createElement)("td",{style:{minWidth:"150px"}},(0,n.createElement)(o.SelectControl,{value:a.rule_type,options:k,onChange:t=>r(e,"rule_type",t),__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",{style:{minWidth:"100px"}},(0,n.createElement)(o.TextControl,{value:a.rule_value,onChange:t=>r(e,"rule_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",{style:{minWidth:"100px"}},(0,n.createElement)(o.TextControl,{value:a.category_value,onChange:t=>r(e,"category_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",{style:{minWidth:"100px"}},(0,n.createElement)(o.TextControl,{value:String(a.min_quantity),onChange:t=>r(e,"min_quantity",parseInt(t)||0),placeholder:"0",type:"number",__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",{style:{minWidth:"150px"}},(0,n.createElement)(o.SelectControl,{value:a.qty_rule_type,options:k,onChange:t=>r(e,"qty_rule_type",t),__nextHasNoMarginBottom:!0})),(0,n.createElement)("td",{style:{minWidth:"100px"}},(0,n.createElement)(o.TextControl,{value:a.qty_rule_value,onChange:t=>r(e,"qty_rule_value",t),placeholder:"0",type:"text",__nextHasNoMarginBottom:!0}))),L=({isOpen:e,title:t,message:a,onConfirm:r,onCancel:l,isDangerous:s=!1})=>e?(0,n.createElement)(o.Modal,{title:t,onRequestClose:l,className:"crp-confirm-dialog"},(0,n.createElement)("p",null,a),(0,n.createElement)("div",{className:"crp-modal-actions",style:{display:"flex",justifyContent:"flex-end",gap:"10px",marginTop:"20px"}},(0,n.createElement)(o.Button,{onClick:l},"Cancel"),(0,n.createElement)(o.Button,{variant:"primary",onClick:r,isDestructive:s},"Confirm"))):null,B=({rules:e,categories:t,isLoading:a,roleFilter:r,onUpdate:s,onBulkUpdate:c,onBulkDelete:i,onRefetch:d})=>{const[p,m]=(0,l.useState)([]),[g,y]=(0,l.useState)(""),[h,E]=(0,l.useState)(""),[v,_]=(0,l.useState)(""),[f,b]=(0,l.useState)(!1),[x,w]=(0,l.useState)(new Map),[C,S]=(0,l.useState)(new Set),[R,B]=(0,l.useState)(!1);(0,l.useEffect)(()=>{const t=new Map;e.forEach(e=>{if(x.has(e.id))t.set(e.id,x.get(e.id));else{const a=e.single_categories?.[0];t.set(e.id,{rule_type:a?.rule?.type||"",rule_value:a?.rule?.value||"",category_value:"",min_quantity:a?.min_qty||0,qty_rule_type:a?.rule?.quantity_type||"",qty_rule_value:a?.rule?.quantity||""})}}),w(t)},[e]);const D=(e,t,a)=>{const r=x.get(e);if(!r)return;const l={...r,[t]:a},n=new Map(x);n.set(e,l),w(n);const o=new Set(C);o.add(e),S(o)},N=(0,l.useMemo)(()=>g?e.filter(e=>{const a=e.single_categories||[];return t.filter(e=>a.includes(e.id)&&e.name.toLowerCase().includes(g.toLowerCase())).length>0}):e,[e,g,t]),q=(e,t)=>{m(t?[...p,e]:p.filter(t=>t!==e))},F=e=>{const t=e.single_categories||[];return 0===t.length?"No categories":t.map(e=>e.name||e.slug||"Unknown").join(", ")||"Unknown"};return a?(0,n.createElement)("div",{style:{display:"flex",justifyContent:"center",padding:"40px"}},(0,n.createElement)(o.Spinner,null)):(0,n.createElement)(n.Fragment,null,(0,n.createElement)("div",{style:{marginBottom:"16px",display:"flex",gap:"10px",alignItems:"flex-end",flexWrap:"wrap"}},(0,n.createElement)("div",{style:{flex:"1",minWidth:"200px"}},(0,n.createElement)(o.TextControl,{label:"Search Categories",value:g,onChange:y,placeholder:"Filter by category name..."})),p.length>0&&(0,n.createElement)(n.Fragment,null,(0,n.createElement)("div",{style:{minWidth:"150px"}},(0,n.createElement)(o.SelectControl,{label:"Bulk Rule Type",value:h,options:k,onChange:E})),(0,n.createElement)(o.Button,{variant:"secondary",onClick:async()=>{0!==p.length&&h&&(await c(p,{rule_type:h}),E(""))},disabled:!h},"Apply Type"),(0,n.createElement)("div",{style:{minWidth:"100px"}},(0,n.createElement)(o.TextControl,{label:"Bulk Value",value:v,onChange:_,placeholder:"e.g., 10"})),(0,n.createElement)(o.Button,{variant:"secondary",onClick:async()=>{0!==p.length&&v&&(await c(p,{rule_value:v}),_(""))},disabled:!v},"Apply Value"),(0,n.createElement)(o.Button,{variant:"secondary",isDestructive:!0,onClick:()=>b(!0)},"Delete (",p.length,")"))),C.size>0&&(0,n.createElement)("div",{className:"crp-save-banner"},(0,n.createElement)("span",{className:"crp-save-banner__message"},(0,n.createElement)("strong",null,C.size)," unsaved change",1!==C.size?"s":""),(0,n.createElement)("div",{className:"crp-save-banner__actions"},(0,n.createElement)(o.Button,{variant:"secondary",onClick:()=>window.location.reload(),disabled:R},"Discard Changes"),(0,n.createElement)(o.Button,{variant:"primary",onClick:async()=>{if(0!==C.size){B(!0);try{for(const t of Array.from(C)){const a=e.find(e=>e.id===t);if(!a)continue;const r=a.single_categories?.map(e=>{const a=x.get(t);return{category_id:e.id,type:a?.rule_type||e.rule?.type||"percentage",value:a?.rule_value||e.rule?.value||"0",min_qty:a?.min_quantity||e.min_qty||0,quantity:a?.qty_rule_value||e.rule?.quantity||"",quantity_type:a?.qty_rule_type||e.rule?.quantity_type||""}})||[];await u()({path:`/rrb2b/v1/rules/${t}/categories`,method:"PUT",data:{rows:r}})}S(new Set),d&&d()}catch(e){console.error("Failed to save changes:",e)}finally{B(!1)}}},isBusy:R,disabled:R},"Save All Changes"))),0===N.length?(0,n.createElement)("div",{style:{padding:"40px",textAlign:"center",background:"#f9f9f9",borderRadius:"4px"}},(0,n.createElement)("p",{style:{margin:0,color:"#757575"}},g?"No categories match your search.":"No category rules found.")):(0,n.createElement)("div",{style:{overflowX:"auto"}},(0,n.createElement)("table",{className:"wp-list-table widefat fixed striped",style:{minWidth:"1200px"}},(0,n.createElement)("thead",null,(0,n.createElement)("tr",null,(0,n.createElement)("th",{style:{width:"40px"}},(0,n.createElement)("input",{type:"checkbox",checked:p.length===N.length&&N.length>0,onChange:()=>{p.length===N.length?m([]):m(N.map(e=>e.id))}})),(0,n.createElement)("th",null,"Category"),(0,n.createElement)("th",null,"Rule Type"),(0,n.createElement)("th",null,"Value"),(0,n.createElement)("th",null,"Cat. Value"),(0,n.createElement)("th",null,"Min Qty"),(0,n.createElement)("th",null,"Qty Rule Type"),(0,n.createElement)("th",null,"Qty Value"),(0,n.createElement)("th",null,"Actions"))),(0,n.createElement)("tbody",null,N.map(e=>{const t=x.get(e.id)||{rule_type:"",rule_value:"",category_value:"",min_quantity:0,qty_rule_type:"",qty_rule_value:""};return(0,n.createElement)(T,{key:e.id,ruleId:e.id,categoryName:F(e),formData:t,onChange:D,onSelect:q,isSelected:p.includes(e.id),hasChanges:C.has(e.id)})})))),(0,n.createElement)(L,{isOpen:f,title:"Delete Selected Rules",message:`Are you sure you want to delete ${p.length} selected rule(s)? This action cannot be undone.`,onConfirm:async()=>{0!==p.length&&(await i(p),m([]),b(!1))},onCancel:()=>b(!1),isDangerous:!0}))},D=({value:e,onChange:t,roles:a,label:r="Select Role",disabled:l=!1})=>{const s=[{label:"Select Role",value:""},...a.map(e=>({label:e.name,value:e.slug}))];return(0,n.createElement)(o.SelectControl,{label:r,value:e,options:s,onChange:t,disabled:l})},N=({value:e,onChange:t,label:a="Categories"})=>{const{categories:r,isLoading:s}=R(),[c,i]=(0,l.useState)(!1),[u,d]=(0,l.useState)(""),p=(0,l.useMemo)(()=>r.filter(t=>e.includes(t.id)),[r,e]),m=(0,l.useMemo)(()=>u?r.filter(e=>e.name.toLowerCase().includes(u.toLowerCase())):r,[r,u]);return(0,n.createElement)("div",{className:"crp-category-multiselect"},(0,n.createElement)("label",{className:"components-base-control__label"},a),(0,n.createElement)("div",{className:"selected-categories",style:{marginBottom:"8px",display:"flex",flexWrap:"wrap",gap:"4px"}},0===p.length?(0,n.createElement)("span",{style:{color:"#757575",fontSize:"13px"}},"No categories selected"):p.map(a=>(0,n.createElement)("span",{key:a.id,className:"category-tag",style:{display:"inline-flex",alignItems:"center",padding:"4px 8px",background:"#f0f0f0",borderRadius:"4px",fontSize:"12px",gap:"6px"}},a.name,(0,n.createElement)("button",{onClick:()=>{return r=a.id,void t(e.filter(e=>e!==r));var r},style:{border:"none",background:"transparent",cursor:"pointer",padding:0,fontSize:"14px",lineHeight:1},"aria-label":`Remove ${a.name}`},"×")))),(0,n.createElement)(o.Button,{variant:"secondary",onClick:()=>i(!c)},c?"Close":"Select Categories"),c&&(0,n.createElement)(o.Popover,{position:"bottom left",onClose:()=>i(!1),className:"crp-category-popover"},(0,n.createElement)("div",{style:{width:"300px",padding:"12px"}},(0,n.createElement)(o.TextControl,{label:"Search",value:u,onChange:d,placeholder:"Search categories..."}),s?(0,n.createElement)("p",null,"Loading categories..."):(0,n.createElement)("div",{style:{maxHeight:"300px",overflowY:"auto",marginTop:"8px"}},0===m.length?(0,n.createElement)("p",{style:{color:"#757575",fontSize:"13px"}},"No categories found"):m.map(a=>(0,n.createElement)(o.CheckboxControl,{key:a.id,label:a.name,checked:e.includes(a.id),onChange:()=>{return r=a.id,void(e.includes(r)?t(e.filter(e=>e!==r)):t([...e,r]));var r}}))))))},q=({roleFilter:e})=>{const[t,a]=(0,l.useState)(""),[r,i]=(0,l.useState)(!1),[d,p]=(0,l.useState)([]),[m,g]=(0,l.useState)(!1),y=e||t,{roles:h,isLoading:E}=(()=>{const[e,t]=(0,l.useState)([]),[a,r]=(0,l.useState)(!1),{createSuccessNotice:n,createErrorNotice:o}=(0,s.useDispatch)(c.store),i=async()=>{r(!0);try{const e=await u()({path:"/rrb2b/v1/roles",method:"GET"});t(e)}catch(e){const t=e instanceof Error?e.message:"Unknown error";o(`Failed to load roles: ${t}`),console.error("Error fetching roles:",e)}finally{r(!1)}};return(0,l.useEffect)(()=>{i()},[]),{roles:e,isLoading:a,createRole:async a=>{try{const r={role_name:a.name,role_slug:a.slug,role_cap:a.baseCap||"customer"},l=(await u()({path:"/rrb2b/v1/roles",method:"POST",data:r})).role;return t([...e,l]),n("Role created successfully!",{type:"snackbar"}),l}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw o(`Failed to create role: ${t}`),e}},deleteRole:async a=>{const r=[...e];t(e.filter(e=>e.slug!==a));try{await u()({path:`/rrb2b/v1/roles/${a}`,method:"DELETE"}),n("Role deleted successfully!",{type:"snackbar"})}catch(e){t(r);const a=e instanceof Error?e.message:"Unknown error";throw o(`Failed to delete role: ${a}`),e}},refetch:i}})(),{categories:v,isLoading:_}=R(),{rules:f,isLoading:b,createRule:x,updateRule:w,bulkUpdate:S,bulkDelete:k,refetch:T}=(e=>{const{rules:t,isLoading:a,error:r}=(0,s.useSelect)(t=>{const a=t(C).getRules();return{rules:e?t(C).getRulesByRole(e):a,isLoading:t(C).isLoading(),error:t(C).getError()}},[e]),{addRule:l,updateRule:n,deleteRule:o,invalidateResolution:i}=(0,s.useDispatch)(C),{createSuccessNotice:d,createErrorNotice:p}=(0,s.useDispatch)(c.store),m=async(e,a)=>{const r=t.find(t=>t.id===e);r&&n({...r,...a});try{const t=await u()({path:`/rrb2b/v1/rules/${e}`,method:"PUT",data:a});return n(t),d("Rule updated successfully!",{type:"snackbar"}),t}catch(e){r&&n(r);const t=e instanceof Error?e.message:"Failed to update rule";throw p(`Failed to update rule: ${t}`),e}},g=async e=>{o(e);try{await u()({path:`/rrb2b/v1/rules/${e}`,method:"DELETE"}),d("Rule deleted successfully!",{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to delete rule";throw p(`Failed to delete rule: ${t}`),e}};return{rules:t,isLoading:a,error:r,createRule:async e=>{try{const t={role_name:e.role},a=await u()({path:"/rrb2b/v1/rules",method:"POST",data:t});if(e.products&&e.products.length>0){const t=e.products.map((t,a)=>{const r=e.productDetails?.[a];return{product_id:t,product_name:r?.name||"",type:e.rule_type||"percentage",value:e.rule_value||"0",min_qty:1}});await u()({path:`/rrb2b/v1/rules/${a.id}/products`,method:"PUT",data:{rows:t}})}if(e.single_categories&&e.single_categories.length>0){const t=e.single_categories.map(t=>({category_id:t,type:e.rule_type||"percentage",value:e.rule_value||"0",min_qty:0}));await u()({path:`/rrb2b/v1/rules/${a.id}/categories`,method:"PUT",data:{rows:t}})}(void 0!==e.active||e.rule_type||e.rule_value)&&await u()({path:`/rrb2b/v1/rules/${a.id}`,method:"PUT",data:{rule_active:e.active,global_rule:e.rule_type&&e.rule_value?{type:e.rule_type,value:e.rule_value}:void 0}});const r=await u()({path:`/rrb2b/v1/rules/${a.id}`,method:"GET"});return l(r),d("Rule created successfully!",{type:"snackbar"}),r}catch(e){const t=e instanceof Error?e.message:"Failed to create rule";throw p(`Failed to create rule: ${t}`),e}},updateRule:m,deleteRule:g,toggleActive:async e=>{const a=t.find(t=>t.id===e);a&&await m(e,{rule_active:!a.rule_active})},copyRule:async(e,t)=>{try{(await u()({path:`/rrb2b/v1/rules/${e}/copy`,method:"POST",data:{destination_roles:t}})).forEach(e=>l(e)),d(`Rule copied to ${t.length} role(s) successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to copy rule";throw p(`Failed to copy rule: ${t}`),e}},bulkUpdate:async(e,t)=>{try{const a=e.map(e=>m(e,t));await Promise.all(a),d(`${e.length} rule(s) updated successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to bulk update";throw p(`Bulk update failed: ${t}`),e}},bulkDelete:async e=>{try{const t=e.map(e=>g(e));await Promise.all(t),d(`${e.length} rule(s) deleted successfully!`,{type:"snackbar"})}catch(e){const t=e instanceof Error?e.message:"Failed to bulk delete";throw p(`Bulk delete failed: ${t}`),e}},refetch:()=>{i("getRules")}}})(y),L=f.filter(e=>e.single_categories&&e.single_categories.length>0);return(0,n.createElement)("div",{className:"crp-categories-tab"},!e&&(0,n.createElement)(n.Fragment,null,(0,n.createElement)("div",{style:{marginBottom:"20px"}},(0,n.createElement)("h2",null,"Category Pricing Rules"),(0,n.createElement)("p",null,"Configure role-based pricing rules for specific product categories.")),(0,n.createElement)("div",{style:{marginBottom:"20px"}},(0,n.createElement)(D,{value:y,onChange:a,roles:h,label:"Filter by Role",disabled:E}))),(0,n.createElement)("div",{style:{marginBottom:"20px"}},(0,n.createElement)(o.Button,{variant:"secondary",onClick:()=>i(!r),disabled:!y&&!e},r?"Cancel":"+ Add Category Rules")),r&&(0,n.createElement)(o.Card,{style:{marginBottom:"20px"}},(0,n.createElement)(o.CardBody,null,(0,n.createElement)("h3",null,"Add Category Rules"),(0,n.createElement)(N,{value:d,onChange:p}),(0,n.createElement)("div",{style:{marginTop:"15px",display:"flex",gap:"10px"}},(0,n.createElement)(o.Button,{variant:"primary",onClick:async()=>{if(y&&0!==d.length){g(!0);try{const e=f.find(e=>e.role_name===y);if(e){const t=[...(e.single_categories||[]).map(e=>({category_id:e.id,type:e.rule?.type||"percentage",value:e.rule?.value||"0",min_qty:e.min_qty||0})),...d.map(e=>({category_id:e,type:"percentage",value:"0",min_qty:0}))];await u()({path:`/rrb2b/v1/rules/${e.id}/categories`,method:"PUT",data:{rows:t}}),T()}else await x({role:y,rule_type:"percentage",rule_value:"0",active:!0,single_categories:d});p([]),i(!1)}catch(e){console.error("Failed to add category rules:",e)}finally{g(!1)}}},isBusy:m,disabled:0===d.length||m},"Add Selected Categories"),(0,n.createElement)(o.Button,{variant:"tertiary",onClick:()=>i(!1)},"Cancel")),(0,n.createElement)("p",{style:{marginTop:"10px",fontSize:"13px",color:"#757575"}},"Select categories and configure pricing rules in the table below."))),(0,n.createElement)(B,{rules:L,categories:v,isLoading:b||_,roleFilter:y,onUpdate:w,onBulkUpdate:S,onBulkDelete:k,onRefetch:T}))};class F extends l.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("React Error:",e,t)}render(){return this.state.hasError?(0,n.createElement)("div",{className:"notice notice-error",style:{padding:"20px",margin:"20px 0"}},(0,n.createElement)("h3",null,"Something went wrong"),(0,n.createElement)("p",null,"The admin interface encountered an error. Please refresh the page to try again."),this.state.error&&(0,n.createElement)("details",{style:{marginTop:"10px"}},(0,n.createElement)("summary",null,"Error details"),(0,n.createElement)("pre",{style:{marginTop:"10px",padding:"10px",background:"#f5f5f5",overflow:"auto"}},this.state.error.toString()))):this.props.children}}const U=F,$=()=>{const e=document.getElementById("crp-categories-root");e&&(0,l.createRoot)(e).render((0,l.createElement)(U,null,(0,l.createElement)(q)))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",$):$()})();